= KUNI-NET Z80 monitor

== 概要
* https://github.com/kuninet/Z80_CPUB[Z80 CPUボード(KZ80-CPUB)]、 https://github.com/kuninet/Z80_1MRAMB[128kB RAMボード(KZ80-1MSRAM)]、 https://github.com/kuninet/Z80_IOB[Z80 I/Oボード(KZ80-IOB)]で動作する機械語モニタープログラムです。
** Z80の固有命令を使用しているためSBC8080/8085では動作しません。
** 8251シリアル入出力ルーチンは、SBC8080データパックのソースを参考にさせていただきました。
** KZ80-CPUB+SBC8080サブボードの組み合わせで使用する場合は、RAMエリアを4000h→8000hへ移動する必要があります。

== 装備しているコマンド
* 本モニターは進化中のため、使用できるコマンドは随時追加されていく予定です。

.コマンド一覧
|===
|コマンド書式|機能

|D XXXX YYYY
|XXXX番地からYYYY番地までのメモリーを16進ダンプ表示する

|H or ?
|コマンドヘルプを表示する

|V
|バージョンを表示する

|L
|(実装予定)IntelHEX形式ファイルをメモリーへロードする

|I XX
|I/O番地XXへI/O入力命令を発行する

|O XX YY
|I/O番地XXへデータYYを出力するI/O出力命令を発行する

|M XXXX
|XXXX番地からのメモリーを変更する

|G XXXX
|XXXX番地からのプログラムを実行する

|===

== ROM作成方法
* アセンブル済みのIntelHEX形式ファイル(obj/Z80mon_KZ80.hex等)やバイナリファイル(obj/Z80mon_KZ80.bin)を使用して、TL866等のEPROMライタでROMを作成して使用してください。
* モニタープログラムは0000番地からスタートするかたちになっています。 

== デバイス依存ソース (deviceディレクトリ)
* デバイス依存ソースは deviceディレクトリに切り分けました。
* 以下の以下のルーチンを記述してください

[cols="1,10a"]
|===

|ルーチン名|内容

|SETINT
|* RST 38hから呼ばれるシリアル割り込みルーチン
* RETの前にEI(割り込み許可)が必須

|CIN
|* 1文字入力ルーチン
* Aレジスタで入力文字コードを戻す

|COUT
|* 1文字出力ルーチン
* Aレジスタで渡された文字を出力する

|CKINCHAR
|* 文字列バッファのカウントが0かどうかをチェックしてフラグを返す

|INIT
|* スタックポインターや各種デバイスの初期化を実施
* ルーチンの最後は EI(割り込み許可)した後 `JP MAIN` でモニターメイン処理へ飛ぶこと

|===

* 機械語モニターソースの末尾にデバイス依存ソースがappendされるかたちとなっています。
* デバイス依存ルーチンで使用するRAMメモリー領域を確保する場合はソースの末尾で定義してください。また、RAM領域の最後に `DEVICE_RAM_END EQU $` の定義を忘れずにお願いします。
* Z80mon.asmではデバイス依存部分を条件コンパイル文で取り込むかたちをとっています。build.shと合わせて適宜修正してください。

== ビルド方法
* Z80アセンブラで記述しています。クロスアセンブラ等でアセンブリしIntelHex形式のファイルやバイナリ形式ファイル(bin)を作成してください。
** クロスアセンブラ http://john.ccac.rwth-aachen.de:8000/as/[The Macroassembler AS]でアセンブリする際のコマンドは build.shとして作成してあります。参考にしてください。

build.shによるビルドディレクトリ
----
./ --+-- lst    リスト形式ファイル
     |
     +-- obj    HEX,bin形式ファイル
     |
     +-- p      ASコンパイル結果(pファイル)
----


== ライセンス
* 本プログラムのうち私が作成した部分はMITライセンスとします。

== 謝辞
* 本モニタープログラムを作成するにあたり、様々な助言、アイデアをいただきました。ありがとうございます。
** @vintagechips さま (SBCシリーズ原作)
** @tendai22plus さま
** @electrelic さま
