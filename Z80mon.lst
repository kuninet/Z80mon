 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 1 - 2019/04/21 23時21分36秒


       1/       0 :                     ;
       2/       0 :                     ; Z80 Monitor
       3/       0 :                     ;
       4/       0 :                     
       5/       0 : =DH                 CR		EQU	0DH
       6/       0 : =AH                 LF		EQU	0AH
       7/       0 : =1BH                ESC		EQU	1BH
       8/       0 : =3H                 CTRLC	EQU	03H
       9/       0 : =CH                 CLS		EQU	0CH
      10/       0 : =20H                SPC		EQU	20h
      11/       0 : =0H                 NULL	EQU 00h
      12/       0 : =7H                 BEEP	EQU 07h
      13/       0 : =8H                 BS		EQU 08h
      14/       0 : =9H                 TAB		EQU 09h
      15/       0 : =7FH                DEL		EQU 7Fh
      16/       0 :                     ;
      17/       0 : =0H                 UARTRD	EQU	00H
      18/       0 : =1H                 UARTRC	EQU	01H
      19/       0 :                     ;
      20/       0 : =3FH                BUFSIZ	EQU	3FH
      21/       0 : =30H                BUFFUL	EQU	30H
      22/       0 : =5H                 BUFEMP	EQU	5
      23/       0 :                     ;
      24/       0 : =17H                RTSHIG	EQU	00010111B
      25/       0 : =37H                RTSLOW	EQU	00110111B
      26/       0 :                     
      27/       0 :                     
      28/       0 :                     ;------------------------------------------------------------------------------
      29/       0 :                     ; RAM バッファ & STACK
      30/       0 :                     ;------------------------------------------------------------------------------
      31/    4000 :                     		ORG	4000h
      32/    4000 :                     ;
      33/    4000 :                     SERBUF	DS	BUFSIZ
      34/    403F :                     SERINP	DS	2
      35/    4041 :                     SERRDP	DS	2
      36/    4043 :                     SERCNT	DS	1
      37/    4044 :                     BASFLG	DS	1
      38/    4045 :                     ;
      39/    4045 :                     INBUF   DS  20
      40/    4059 : =14H                INMAX   EQU  $-INBUF
      41/    4059 :                     INEND   DS  1
      42/    405A :                     ;
      43/    405A :                     ARGC	DS	1
      44/    405B :                     ARGV_1	DS	2
      45/    405D :                     ARGV_2	DS	2
      46/    405F :                     ARGV_3	DS	2
      47/    4061 : =3H                 ARG_MAX	EQU ($-ARGV_1)/2
      48/    4061 : =7H                 ARG_AREA_LEN EQU $-ARGC
      49/    4061 :                     ;
      50/    4061 :                         	DS	32
      51/    4081 : =4081H              STACK   	EQU    $
      52/    4081 :                     
      53/    4081 :                     
      54/    4081 :                     
      55/       0 :                     		ORG	0000h
      56/       0 :                     ;------------------------------------------------------------------------------
      57/       0 :                     ; RST00 リセット
      58/       0 :                     ;------------------------------------------------------------------------------
      59/       0 : F3                  RST00		DI		
      60/       1 : C3 51 01            		JP	INIT	
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 2 - 2019/04/21 23時21分36秒


      61/       4 :                     
      62/       4 :                     ;------------------------------------------------------------------------------
      63/       4 :                     ; RST08 1文字送信
      64/       4 :                     ;------------------------------------------------------------------------------
      65/       8 :                     	ORG	0008H
      66/       8 : C3 A7 00            RST08		JP	COUT
      67/       B :                     
      68/       B :                     ;------------------------------------------------------------------------------
      69/       B :                     ; RST10 1文字受信
      70/       B :                     ;------------------------------------------------------------------------------
      71/      10 :                     	ORG	0010H
      72/      10 : C3 79 00            RST10		JP	CIN
      73/      13 :                     
      74/      13 :                     ;------------------------------------------------------------------------------
      75/      13 :                     ; RST18 入力バッファチェック
      76/      13 :                     ;------------------------------------------------------------------------------
      77/      18 :                     	ORG	0018H
      78/      18 : C3 B3 00            RST18		JP	CKINCHAR
      79/      1B :                     
      80/      1B :                     ;------------------------------------------------------------------------------
      81/      1B :                     ; RST38 8251A割り込みルーチン
      82/      1B :                     ;------------------------------------------------------------------------------
      83/      38 :                     	ORG	0038H
      84/      38 : C3 3B 00            RST38:	JP	SERINT 
      85/      3B :                     
      86/      3B :                     ;------------------------------------------------------------------------------
      87/      3B :                     ; 8251割り込みルーチン
      88/      3B :                     ;------------------------------------------------------------------------------
      89/      3B : F5                  SERINT:	PUSH	AF
      90/      3C : E5                  	PUSH	HL
      91/      3D : DB 01               	IN	A,(UARTRC)
      92/      3F : E6 02               	AND	00000010B
      93/      41 : CA 75 00            	JP	Z,RTS0
      94/      44 : DB 00               	IN	A,(UARTRD)
      95/      46 : F5                  	PUSH	AF
      96/      47 : 3A 43 40            	LD	A,(SERCNT)
      97/      4A : FE 3F               	CP	BUFSIZ
      98/      4C : C2 53 00            	JP	NZ,NOTFUL
      99/      4F : F1                  	POP	AF
     100/      50 : C3 75 00            	JP	RTS0
     101/      53 : 2A 3F 40            NOTFUL:	LD	HL,(SERINP)
     102/      56 : 23                  	INC	HL
     103/      57 : 7D                  	LD	A,L
     104/      58 : FE 3F               	CP	SERINP & 0FFH
     105/      5A : C2 60 00            	JP	NZ,NOTWRP
     106/      5D : 21 00 40            	LD	HL,SERBUF
     107/      60 : 22 3F 40            NOTWRP:	LD	(SERINP),HL
     108/      63 : F1                  	POP	AF
     109/      64 : 77                  	LD	(HL),A
     110/      65 : 3A 43 40            	LD	A,(SERCNT)
     111/      68 : 3C                  	INC	A
     112/      69 : 32 43 40            	LD	(SERCNT),A
     113/      6C : FE 30               	CP	BUFFUL
     114/      6E : DA 75 00            	JP	C,RTS0
     115/      71 : 3E 17               	LD	A,RTSHIG
     116/      73 : D3 01               	OUT	(UARTRC),A
     117/      75 : E1                  RTS0:	POP	HL
     118/      76 : F1                  	POP	AF
     119/      77 : FB                  	EI
     120/      78 : C9                  	RET
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 3 - 2019/04/21 23時21分36秒


     121/      79 :                     
     122/      79 :                     ;------------------------------------------------------------------------------
     123/      79 :                     ; 1文字入力(バッファから)
     124/      79 :                     ;------------------------------------------------------------------------------
     125/      79 :                     CIN:
     126/      79 : 3A 43 40            	LD	A,(SERCNT)
     127/      7C : FE 00               	CP	00H
     128/      7E : CA 79 00            	JP	Z,CIN
     129/      81 : E5                  	PUSH	HL
     130/      82 : 2A 41 40            	LD	HL,(SERRDP)
     131/      85 : 23                  	INC	HL
     132/      86 : 7D                  	LD	A,L
     133/      87 : FE 3F               	CP	SERINP & 0FFH
     134/      89 : C2 8F 00            	JP	NZ,NRWRAP
     135/      8C : 21 00 40            	LD	HL,SERBUF
     136/      8F : F3                  NRWRAP:	DI
     137/      90 : 22 41 40            	LD	(SERRDP),HL
     138/      93 : 3A 43 40            	LD	A,(SERCNT)
     139/      96 : 3D                  	DEC	A
     140/      97 : 32 43 40            	LD	(SERCNT),A
     141/      9A : FE 05               	CP	BUFEMP
     142/      9C : D2 A3 00            	JP	NC,RTS1
     143/      9F : 3E 37               	LD	A,RTSLOW
     144/      A1 : D3 01               	OUT	(UARTRC),A
     145/      A3 : 7E                  RTS1:	LD	A,(HL)
     146/      A4 : FB                  	EI
     147/      A5 : E1                  	POP	HL
     148/      A6 : C9                  	RET	
     149/      A7 :                     
     150/      A7 :                     ;------------------------------------------------------------------------------
     151/      A7 :                     ; 1文字出力
     152/      A7 :                     ;------------------------------------------------------------------------------
     153/      A7 : F5                  COUT:		PUSH	AF
     154/      A8 : DB 01               COUT1:	IN	A,(UARTRC)
     155/      AA : E6 01               	AND	01H     
     156/      AC : CA A8 00            	JP	Z,COUT1
     157/      AF : F1                  	POP	AF
     158/      B0 : D3 00               	OUT	(UARTRD),A
     159/      B2 : C9                  	RET
     160/      B3 :                     
     161/      B3 :                     ;------------------------------------------------------------------------------
     162/      B3 :                     ; 入力バッファチェック
     163/      B3 :                     ;------------------------------------------------------------------------------
     164/      B3 : 3A 43 40            CKINCHAR	LD	A,(SERCNT)
     165/      B6 : FE 00               	CP	00H
     166/      B8 : C9                  	RET
     167/      B9 :                     
     168/      B9 :                     ;==============================================================================
     169/      B9 :                     ;------------------------------------------------------------------------------
     170/      B9 :                     ; 1文字入力 英字大文字対応
     171/      B9 :                     ;------------------------------------------------------------------------------
     172/      B9 :                     GETC:
     173/      B9 : D7                      RST 10h
     174/      BA : FE 61                   CP 'a'
     175/      BC : F8                      RET M
     176/      BD : FE 7B                   CP 'z'+1
     177/      BF : F0                      RET P
     178/      C0 : D6 20                   SUB A,20H
     179/      C2 : C9                      RET
     180/      C3 :                     
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 4 - 2019/04/21 23時21分36秒


     181/      C3 :                     ;------------------------------------------------------------------------------
     182/      C3 :                     ; 文字列入力 エコーバックつき
     183/      C3 :                     ;------------------------------------------------------------------------------
     184/      C3 :                     STRIN:
     185/      C3 :                     ; INBUF クリア
     186/      C3 : 3E 00                   LD A,00H
     187/      C5 : 32 45 40                LD (INBUF),A
     188/      C8 : 21 45 40                LD HL,INBUF
     189/      CB : 11 46 40                LD DE,INBUF+1
     190/      CE : 01 14 00                LD BC,INMAX
     191/      D1 : ED B0                   LDIR
     192/      D3 :                     ;
     193/      D3 : 21 45 40                LD HL,INBUF
     194/      D6 :                     ;
     195/      D6 :                     _STRIN_LOOP:
     196/      D6 : CD B9 00                CALL GETC
     197/      D9 : FE 0D                   CP 0Dh
     198/      DB : 28 39                   JR Z,_STRIN_END
     199/      DD : FE 08                   CP BS
     200/      DF : 28 1D                   JR Z,_BS_RTN
     201/      E1 : FE 7F               	CP DEL
     202/      E3 : 28 19                   JR Z,_BS_RTN
     203/      E5 :                     ;
     204/      E5 :                     ; バッファENDにきた?
     205/      E5 : 47                  	LD B,A
     206/      E6 : 11 59 40            	LD DE,INEND
     207/      E9 : 7A                  	LD A,D
     208/      EA : BC                  	CP H
     209/      EB : 20 05               	JR NZ,_CHAR_SET
     210/      ED : 7B                  	LD A,E
     211/      EE : BD                  	CP L
     212/      EF : 28 08               	JR Z,_WARN_BEEP
     213/      F1 : 78                  	LD A,B
     214/      F2 :                     _CHAR_SET:
     215/      F2 : 77                      LD (HL),A
     216/      F3 : 23                      INC HL
     217/      F4 : CD 23 01                call CPRINT
     218/      F7 : 18 DD                   JR _STRIN_LOOP
     219/      F9 :                     ;
     220/      F9 :                     _WARN_BEEP:
     221/      F9 : 3E 07               	LD A,BEEP
     222/      FB : CF                  	RST 08h
     223/      FC : 18 D8                   JR _STRIN_LOOP
     224/      FE :                     ;
     225/      FE :                     _BS_RTN:
     226/      FE : 11 45 40            	LD DE,INBUF
     227/     101 : 7A                  	LD A,D
     228/     102 : BC                  	CP H
     229/     103 : 20 ED               	JR NZ,_CHAR_SET
     230/     105 : 7B                  	LD A,E
     231/     106 : BD                  	CP L
     232/     107 : 28 F0               	JR Z,_WARN_BEEP
     233/     109 :                     ;
     234/     109 : E5                      PUSH HL
     235/     10A : 21 29 03                LD HL,BSTXT
     236/     10D : CD 1A 01                CALL STRPR
     237/     110 : E1                      POP HL
     238/     111 : 2B                      DEC HL
     239/     112 : 36 00                   LD (HL),00h
     240/     114 : 18 C0                   JR _STRIN_LOOP
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 5 - 2019/04/21 23時21分36秒


     241/     116 :                     ;
     242/     116 :                     _STRIN_END:
     243/     116 : CD 29 01                CALL CRLF_PRINT
     244/     119 : C9                      RET
     245/     11A :                     
     246/     11A :                     ;------------------------------------------------------------------------------
     247/     11A :                     ; 文字列出力
     248/     11A :                     ;------------------------------------------------------------------------------
     249/     11A :                     STRPR:
     250/     11A : 7E                      LD A,(HL)
     251/     11B : B7                      OR A
     252/     11C : C8                      RET Z
     253/     11D : CD 23 01                CALL CPRINT
     254/     120 : 23                      INC HL
     255/     121 : 18 F7                   JR STRPR
     256/     123 :                     
     257/     123 :                     ;------------------------------------------------------------------------------
     258/     123 :                     ; 文字出力 (CRLF対応)
     259/     123 :                     ; IN: A - キャラクタ
     260/     123 :                     ; RET: なし
     261/     123 :                     ;------------------------------------------------------------------------------
     262/     123 :                     CPRINT:
     263/     123 : FE 0D                   CP 0Dh
     264/     125 : 28 02                   JR Z,CRLF_PRINT
     265/     127 : CF                      RST 08h
     266/     128 : C9                      RET
     267/     129 :                     
     268/     129 :                     ;------------------------------------------------------------------------------
     269/     129 :                     ; CRLF出力 (CRLF対応)
     270/     129 :                     ;------------------------------------------------------------------------------
     271/     129 :                     CRLF_PRINT:
     272/     129 : 3E 0D                   LD A,0DH
     273/     12B : CF                      RST 08H
     274/     12C : 3E 0A                   LD A,0AH
     275/     12E : CF                      RST 08h
     276/     12F : C9                      RET
     277/     130 :                     
     278/     130 :                     ;------------------------------------------------------------------------------
     279/     130 :                     ; ブランク出力 
     280/     130 :                     ;------------------------------------------------------------------------------
     281/     130 :                     SPC_PRINT:
     282/     130 : 3E 20                   LD A,SPC
     283/     132 : CF                      RST 08H
     284/     133 : C9                      RET
     285/     134 :                     
     286/     134 :                     ;------------------------------------------------------------------------------
     287/     134 :                     ; Hex2桁出力
     288/     134 :                     ;------------------------------------------------------------------------------
     289/     134 :                     HEX2OUT:
     290/     134 : C5                  	PUSH BC
     291/     135 : 47                  	LD B,A
     292/     136 : CB 3F               	SRL A
     293/     138 : CB 3F               	SRL A
     294/     13A : CB 3F               	SRL A
     295/     13C : CB 3F               	SRL A
     296/     13E : CD 49 01            	CALL _HEX_CNV_PR
     297/     141 : 78                  	LD A,B
     298/     142 : E6 0F               	AND 0Fh
     299/     144 : CD 49 01            	CALL _HEX_CNV_PR
     300/     147 : C1                  	POP BC
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 6 - 2019/04/21 23時21分36秒


     301/     148 : C9                  	RET
     302/     149 :                     ;
     303/     149 :                     _HEX_CNV_PR:	
     304/     149 : C6 90               	ADD A,90h
     305/     14B : 27                  	DAA
     306/     14C : CE 40               	ADC	A,40h
     307/     14E : 27                  	DAA
     308/     14F : CF                  	RST 08h
     309/     150 : C9                  	RET
     310/     151 :                     
     311/     151 :                     
     312/     151 :                     ;==============================================================================
     313/     151 :                     ;------------------------------------------------------------------------------
     314/     151 :                     ; 初期化
     315/     151 :                     ;------------------------------------------------------------------------------
     316/     151 :                     INIT:		
     317/     151 : 31 81 40                LD  SP,STACK
     318/     154 : 21 00 40            	LD	HL,SERBUF
     319/     157 : 22 3F 40            	LD	(SERINP),HL
     320/     15A : 22 41 40            	LD	(SERRDP),HL
     321/     15D : AF                  	XOR	A
     322/     15E : 32 43 40            	LD	(SERCNT),A
     323/     161 : D3 01               	OUT	(UARTRC),A
     324/     163 : D3 01               	OUT	(UARTRC),A
     325/     165 : D3 01               	OUT	(UARTRC),A
     326/     167 : 3E 40               	LD	A,01000000B
     327/     169 : D3 01               	OUT	(UARTRC),A
     328/     16B : 3E 4E               	LD	A,01001110B
     329/     16D : D3 01               	OUT	(UARTRC),A
     330/     16F : 3E 37               	LD	A,RTSLOW
     331/     171 : D3 01               	OUT	(UARTRC),A
     332/     173 : FB                  	EI
     333/     174 :                     ;
     334/     174 :                     ;--------------------------------------------------------------------------------
     335/     174 :                     ; メイン
     336/     174 :                     ;--------------------------------------------------------------------------------
     337/     174 :                     MAIN:
     338/     174 : 21 06 03                LD HL,OPENMSG
     339/     177 : CD 1A 01                CALL STRPR
     340/     17A :                     _MAIN_LOOP:
     341/     17A : 3E 3E                   LD A,'>'
     342/     17C : CF                      RST 08h
     343/     17D : DD 21 DE 02             LD IX,CMD_TBL
     344/     181 : CD B9 00            	CALL GETC
     345/     184 : CF                      RST 08H
     346/     185 :                     ;
     347/     185 :                     _CMD_LOOP:
     348/     185 : F5                  	PUSH AF
     349/     186 : DD 7E 00                LD A,(IX+0)
     350/     189 : B7                  	OR A
     351/     18A : 28 14               	JR Z,_ERROR_EXIT
     352/     18C : 47                  	LD B,A
     353/     18D : F1                  	POP AF
     354/     18E : B8                      CP B
     355/     18F : 20 07               	JR NZ,_NEXT_CMD
     356/     191 : DD 6E 01                LD L,(IX+1)
     357/     194 : DD 66 02            	LD H,(IX+2)
     358/     197 : E9                  	JP (HL)
     359/     198 :                     _NEXT_CMD:
     360/     198 : DD 23               	INC IX
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 7 - 2019/04/21 23時21分36秒


     361/     19A : DD 23               	INC IX
     362/     19C : DD 23               	INC IX
     363/     19E : 18 E5               	JR _CMD_LOOP
     364/     1A0 :                     ;;
     365/     1A0 :                     _ERROR_EXIT
     366/     1A0 : CD 29 01            	CALL CRLF_PRINT
     367/     1A3 : 3E 3F               	LD A,'?'
     368/     1A5 : CD 29 01            	CALL CRLF_PRINT
     369/     1A8 :                     _MAIN_LOOP_END:
     370/     1A8 : CD 29 01                call    CRLF_PRINT
     371/     1AB : 18 CD                   JR      _MAIN_LOOP
     372/     1AD :                     
     373/     1AD :                     ;--------------------------------------------------------------------------------
     374/     1AD :                     ; ヘルプ出力
     375/     1AD :                     ;--------------------------------------------------------------------------------
     376/     1AD :                     HELP_OUT:
     377/     1AD : 21 2D 03                LD HL,HELP_MSG
     378/     1B0 : 18 03               	JR _PRINT_END
     379/     1B2 :                     ;
     380/     1B2 :                     ;--------------------------------------------------------------------------------
     381/     1B2 :                     ; バージョン出力
     382/     1B2 :                     ;--------------------------------------------------------------------------------
     383/     1B2 :                     VERSION_OUT:
     384/     1B2 : 21 EB 02                LD HL,VERMSG
     385/     1B5 :                     _PRINT_END:
     386/     1B5 : CD 29 01            	CALL CRLF_PRINT
     387/     1B8 : CD 1A 01                CALL STRPR
     388/     1BB : CD 29 01            	CALL CRLF_PRINT
     389/     1BE : C3 7A 01                JP _MAIN_LOOP
     390/     1C1 : C9                      RET
     391/     1C2 :                     
     392/     1C2 :                     ;--------------------------------------------------------------------------------
     393/     1C2 :                     ; HEX4桁出力
     394/     1C2 :                     ;--------------------------------------------------------------------------------
     395/     1C2 :                     HEX4OUT:
     396/     1C2 : F5                  	PUSH AF
     397/     1C3 : 7C                  	LD A,H
     398/     1C4 : CD 34 01            	CALL HEX2OUT
     399/     1C7 : 7D                  	LD A,L
     400/     1C8 : CD 34 01            	CALL HEX2OUT
     401/     1CB : F1                  	POP AF
     402/     1CC : C9                  	RET
     403/     1CD :                     
     404/     1CD :                     ;--------------------------------------------------------------------------------
     405/     1CD :                     ; 入力行パース
     406/     1CD :                     ;--------------------------------------------------------------------------------
     407/     1CD :                     PARSER:
     408/     1CD :                     ; 編集エリア初期化
     409/     1CD : 21 5A 40            	LD HL,ARGC
     410/     1D0 : 3E 00               	LD A,0
     411/     1D2 : 77                  	LD (HL),A
     412/     1D3 : 11 5B 40            	LD DE,ARGC+1
     413/     1D6 : 01 06 00            	LD BC,ARG_AREA_LEN-1
     414/     1D9 : ED B0               	LDIR
     415/     1DB :                     ; 入力パラメーター パース開始
     416/     1DB : 4F                  	LD C,A
     417/     1DC : 21 44 40            	LD HL,INBUF-1
     418/     1DF : DD 21 5B 40         	LD IX,ARGV_1
     419/     1E3 :                     ;
     420/     1E3 :                     _PARSE_LOOP:
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 8 - 2019/04/21 23時21分36秒


     421/     1E3 : 23                  	INC HL
     422/     1E4 : 7E                  	LD A,(HL)
     423/     1E5 : FE 00               	CP NULL
     424/     1E7 : C8                  	RET Z
     425/     1E8 : FE 20               	CP SPC
     426/     1EA : 28 F7               	JR Z,_PARSE_LOOP
     427/     1EC : 0C                      INC C
     428/     1ED : 79                  	LD A,C
     429/     1EE : FE 04               	CP ARG_MAX+1
     430/     1F0 : 30 1B               	JR NC,_PARSE_ERR
     431/     1F2 : 32 5A 40            	LD (ARGC),A
     432/     1F5 : DD 75 00            	LD (IX+0),L
     433/     1F8 : DD 74 01            	LD (IX+1),H
     434/     1FB : DD 23               	INC IX
     435/     1FD : DD 23               	INC IX
     436/     1FF :                     _PARAM_LOOP:
     437/     1FF : 23                  	INC HL
     438/     200 : 7E                  	LD A,(HL)
     439/     201 : FE 00               	CP NULL
     440/     203 : C8                  	RET Z
     441/     204 : FE 20               	CP SPC
     442/     206 : 20 F7               	JR NZ,_PARAM_LOOP
     443/     208 : 3E 00               	LD A,NULL
     444/     20A : 77                  	LD (HL),A
     445/     20B : 18 D6               	JR _PARSE_LOOP
     446/     20D :                     ;
     447/     20D :                     _PARSE_ERR:
     448/     20D : 3F                  	CCF
     449/     20E : C9                  	RET
     450/     20F :                     
     451/     20F :                     ;--------------------------------------------------------------------------------
     452/     20F :                     ; HEX 2桁キャラクタ → Aレジスタ
     453/     20F :                     ;--------------------------------------------------------------------------------
     454/     20F :                     HEX2BIN:
     455/     20F : 7E                  	LD A,(HL)
     456/     210 : CD 25 02            	CALL _ATOBIN
     457/     213 : D8                  	RET C
     458/     214 : CB 27               	SLA A
     459/     216 : CB 27               	SLA A
     460/     218 : CB 27               	SLA A
     461/     21A : CB 27               	SLA A
     462/     21C : 47                  	LD B,A
     463/     21D : 23                  	INC HL
     464/     21E : 7E                  	LD A,(HL)
     465/     21F : CD 25 02            	CALL _ATOBIN
     466/     222 : D8                  	RET C
     467/     223 : 80                  	ADD A,B
     468/     224 : C9                  	RET
     469/     225 :                     ;
     470/     225 :                     _ATOBIN:
     471/     225 : FE 30               	CP '0'
     472/     227 : D8                  	RET C
     473/     228 : FE 3A               	CP '9'+1
     474/     22A : 38 09               	JR C,_ATOBIN1
     475/     22C : FE 41               	CP 'A'
     476/     22E : D8                  	RET C
     477/     22F : FE 47               	CP 'F'+1
     478/     231 : 3F                  	CCF
     479/     232 : D8                  	RET C
     480/     233 : C6 09               	ADD A,09H
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 9 - 2019/04/21 23時21分36秒


     481/     235 :                     _ATOBIN1:
     482/     235 : E6 0F               	AND 0Fh
     483/     237 : C9                  	RET
     484/     238 :                     ;
     485/     238 :                     
     486/     238 :                     ;--------------------------------------------------------------------------------
     487/     238 :                     ; 4バイト16進数文字列→バイナリ(HL)へ
     488/     238 :                     ;--------------------------------------------------------------------------------
     489/     238 :                     HEX4BIN:
     490/     238 : CD 0F 02            	CALL HEX2BIN
     491/     23B : D8                  	RET C
     492/     23C : 57                  	LD D,A
     493/     23D : 23                  	INC HL
     494/     23E : CD 0F 02            	CALL HEX2BIN
     495/     241 : D8                  	RET C
     496/     242 : 5F                  	LD E,A
     497/     243 : D5                  	PUSH DE
     498/     244 : E1                  	POP HL
     499/     245 : C9                  	RET
     500/     246 :                     ;--------------------------------------------------------------------------------
     501/     246 :                     ; メモリーダンプ
     502/     246 :                     ;--------------------------------------------------------------------------------
     503/     246 :                     MEM_DUMP:
     504/     246 : CD 30 01                CALL SPC_PRINT
     505/     249 :                     ;
     506/     249 : CD C3 00                CALL STRIN
     507/     24C : CD CD 01            	CALL PARSER
     508/     24F : 38 45               	JR C,_PARAM_ERR
     509/     251 :                     ; 入力パラメータ数チェック
     510/     251 : 3A 5A 40            	LD A,(ARGC)
     511/     254 : FE 02               	CP 2
     512/     256 : 20 3E               	JR NZ,_PARAM_ERR
     513/     258 :                     ; 開始アドレス取得
     514/     258 : 2A 5B 40            	LD HL,(ARGV_1)
     515/     25B : CD 38 02            	CALL HEX4BIN
     516/     25E : 38 36               	JR C,_PARAM_ERR
     517/     260 : E5                  	PUSH HL
     518/     261 : DD E1               	POP IX
     519/     263 :                     ; 終了アドレス取得
     520/     263 : 2A 5D 40            	LD HL,(ARGV_2)
     521/     266 : CD 38 02            	CALL HEX4BIN
     522/     269 : 38 2B               	JR C,_PARAM_ERR
     523/     26B : E5                  	PUSH HL
     524/     26C : D1                  	POP DE
     525/     26D : DD E5               	PUSH IX
     526/     26F : E1                  	POP HL
     527/     270 :                     ; ダンプ実施
     528/     270 :                     _DUMP_LOOP:
     529/     270 : DF                  	RST 18h
     530/     271 : 28 05               	JR Z,_DUMP_GO
     531/     273 : D7                  	RST 10h
     532/     274 : FE 1B               	CP ESC
     533/     276 : 28 24               	JR Z,_ABORT_DUMP
     534/     278 :                     _DUMP_GO:
     535/     278 : E5                  	PUSH HL
     536/     279 : CD C0 02            	CALL DUMP16
     537/     27C : E1                  	POP HL
     538/     27D : CD A2 02            	CALL ASC16
     539/     280 : CD 29 01            	CALL CRLF_PRINT
     540/     283 :                     ; 終了判定
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 10 - 2019/04/21 23時21分36秒


     541/     283 : 7A                  	LD A,D
     542/     284 : BC                  	CP H
     543/     285 : FA 7A 01            	JP M,_MAIN_LOOP
     544/     288 : 7B                  	LD A,E
     545/     289 : BD                  	CP L
     546/     28A : FA 8F 02            	JP M,_DUMP_END_CHECK
     547/     28D : 18 E1               	JR _DUMP_LOOP
     548/     28F :                     ;
     549/     28F :                     _DUMP_END_CHECK:
     550/     28F : 7A                  	LD A,D
     551/     290 : BC                  	CP H
     552/     291 : 20 DD               	JR NZ,_DUMP_LOOP
     553/     293 : C3 7A 01            	JP _MAIN_LOOP
     554/     296 :                     ;
     555/     296 :                     _PARAM_ERR:
     556/     296 : 21 88 03            	LD HL,PARAM_ERRMSG
     557/     299 : C3 B5 01            	JP _PRINT_END
     558/     29C :                     ;
     559/     29C :                     _ABORT_DUMP:
     560/     29C : 21 9B 03            	LD HL,ABORT_MSG
     561/     29F : C3 B5 01            	JP _PRINT_END
     562/     2A2 :                     ;--------------------------------------------------------------------------------
     563/     2A2 :                     ; 16バイト分 ASCII出力
     564/     2A2 :                     ;--------------------------------------------------------------------------------
     565/     2A2 :                     ASC16:
     566/     2A2 : CD 30 01            	CALL SPC_PRINT
     567/     2A5 : 3E 3A               	LD A,':'
     568/     2A7 : CF                  	RST 08h
     569/     2A8 : CD 30 01            	CALL SPC_PRINT
     570/     2AB : 0E 10               	LD C,10h
     571/     2AD :                     ;
     572/     2AD :                     _ASC16_LOOP:
     573/     2AD : 7E                  	LD A,(HL)
     574/     2AE : FE 20               	CP ' '
     575/     2B0 : FA B8 02            	JP M,_ASC16_DOT
     576/     2B3 : FE 7F               	CP 7Fh
     577/     2B5 : FA BA 02            	JP M,_ASC16_PRINT
     578/     2B8 :                     _ASC16_DOT:
     579/     2B8 : 3E 2E               	LD A,'.'
     580/     2BA :                     _ASC16_PRINT:
     581/     2BA : CF                  	RST 08h	
     582/     2BB : 23                  	INC HL
     583/     2BC : 0D                  	DEC C
     584/     2BD : C8                  	RET Z
     585/     2BE : 18 ED               	JR _ASC16_LOOP
     586/     2C0 :                     ;--------------------------------------------------------------------------------
     587/     2C0 :                     ; 16バイト分 HEXダンプ出力
     588/     2C0 :                     ;--------------------------------------------------------------------------------
     589/     2C0 :                     DUMP16:
     590/     2C0 : CD C2 01            	CALL HEX4OUT
     591/     2C3 : CD 30 01            	CALL SPC_PRINT
     592/     2C6 : 3E 3A               	LD A,':'
     593/     2C8 : CF                  	RST 08h
     594/     2C9 : CD 30 01            	CALL SPC_PRINT
     595/     2CC : 0E 10               	LD C,10h
     596/     2CE :                     _DUMP16_LOOP:
     597/     2CE : CD D9 02            	CALL DUMP_AT
     598/     2D1 : CD 30 01            	CALL SPC_PRINT
     599/     2D4 : 23                  	INC HL
     600/     2D5 : 0D                  	DEC C
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 11 - 2019/04/21 23時21分36秒


     601/     2D6 : C8                  	RET Z
     602/     2D7 : 18 F5               	JR _DUMP16_LOOP
     603/     2D9 :                     
     604/     2D9 :                     ;--------------------------------------------------------------------------------
     605/     2D9 :                     ; 1バイト分 HEXダンプ出力
     606/     2D9 :                     ;--------------------------------------------------------------------------------
     607/     2D9 :                     DUMP_AT:
     608/     2D9 : 7E                  	LD A,(HL)
     609/     2DA : CD 34 01            	CALL HEX2OUT
     610/     2DD : C9                  	RET
     611/     2DE :                     ;
     612/     2DE :                     ;--------------------------------------------------------------------------------
     613/     2DE :                     ; コマンドテーブル
     614/     2DE :                     ;--------------------------------------------------------------------------------
     615/     2DE :                     CMD_TBL:
     616/     2DE : 48                      DB 'H'
     617/     2DF : AD 01                   DW HELP_OUT
     618/     2E1 : 3F                      DB '?'
     619/     2E2 : AD 01                   DW HELP_OUT
     620/     2E4 : 56                      DB 'V'
     621/     2E5 : B2 01                   DW VERSION_OUT
     622/     2E7 : 44                      DB 'D'
     623/     2E8 : 46 02                   DW MEM_DUMP
     624/     2EA :                     ; TABLE END
     625/     2EA : 00                      DB 00h
     626/     2EB :                     ;
     627/     2EB :                     ;--------------------------------------------------------------------------------
     628/     2EB :                     ; メッセージなど
     629/     2EB :                     ;--------------------------------------------------------------------------------
     630/     2EB : =KUNI-NET Z8..      VERNAME EQU "KUNI-NET Z80 MONITOR v0.1"
     631/     2EB : 4B 55 4E 49 2D 4E   VERMSG  DB VERNAME,CR,0
                    45 54 20 5A 38 30 
                    20 4D 4F 4E 49 54 
                    4F 52 20 76 30 2E 
                    31 0D 00 
     632/     306 : 0D 0D 2A 2A 20 4B   OPENMSG DB CR,CR,"** ",VERNAME," **",CR,0
                    55 4E 49 2D 4E 45 
                    54 20 5A 38 30 20 
                    4D 4F 4E 49 54 4F 
                    52 20 76 30 2E 31 
                    20 2A 2A 0D 00 
     633/     329 : 08 20 08 00         BSTXT	DB BS,SPC,BS,0
     634/     32D : 2D 20 2D 20 2D 20   HELP_MSG DB "- - - COMMAND HELP - - -",CR
                    43 4F 4D 4D 41 4E 
                    44 20 48 45 4C 50 
                    20 2D 20 2D 20 2D 
                    0D 
     635/     346 : 44 20 58 58 58 58            DB "D XXXX XXXX ",TAB,"MEMORY DUMP",CR
                    20 58 58 58 58 20 
                    09 4D 45 4D 4F 52 
                    59 20 44 55 4D 50 
                    0D 
     636/     35F : 48 20 09 09 48 45            DB "H ",TAB,TAB,"HELP MESSGAE",CR
                    4C 50 20 4D 45 53 
                    53 47 41 45 0D 
     637/     370 : 56 20 09 09 56 45            DB "V ",TAB,TAB,"VERSION INFOMATION",CR,0
                    52 53 49 4F 4E 20 
                    49 4E 46 4F 4D 41 
                    54 49 4F 4E 0D 00 
     638/     388 : 07 2A 2A 20 50 41   PARAM_ERRMSG DB BEEP,"** PARAMETER ERR",CR,0
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 12 - 2019/04/21 23時21分36秒


                    52 41 4D 45 54 45 
                    52 20 45 52 52 0D 
                    00 
     639/     39B : 07 2A 2A 20 4D 45   ABORT_MSG DB BEEP,"** MEM DUMP ABORTED END",CR,0
                    4D 20 44 55 4D 50 
                    20 41 42 4F 52 54 
                    45 44 20 45 4E 44 
                    0D 00 
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 13 - 2019/04/21 23時21分36秒


  symbol table (* = unused):
  ------------------------

 ABORT_MSG :                    39B C | *ARCHITECTURE :    x86_64-apple-osx - |
 ARGC :                        405A C |  ARGV_1 :                      405B C |
 ARGV_2 :                      405D C | *ARGV_3 :                      405F C |
 ARG_AREA_LEN :                   7 - |  ARG_MAX :                        3 - |
 ASC16 :                        2A2 C | *BASFLG :                      4044 C |
 BEEP :                           7 - | *BIGENDIAN :                      0 - |
*BRANCHEXT :                      0 - |  BS :                             8 - |
 BSTXT :                        329 C |  BUFEMP :                         5 - |
 BUFFUL :                        30 - |  BUFSIZ :                        3F - |
*CASESENSITIVE :                  0 - |  CIN :                           79 C |
 CKINCHAR :                      B3 C | *CLS :                            C - |
 CMD_TBL :                      2DE C | *CONSTPI :        3.141592653589793 - |
 COUT :                          A7 C |  COUT1 :                         A8 C |
 CPRINT :                       123 C |  CR :                             D - |
 CRLF_PRINT :                   129 C | *CTRLC :                          3 - |
*DATE :                  2019/04/21 - |  DEL :                           7F - |
 DUMP16 :                       2C0 C |  DUMP_AT :                      2D9 C |
 ESC :                           1B - | *FALSE :                          0 - |
*FULLPMMU :                       1 - |  GETC :                          B9 C |
*HAS64 :                          1 - | *HASDSP :                         0 - |
*HASFPU :                         0 - | *HASPMMU :                        0 - |
 HELP_MSG :                     32D C |  HELP_OUT :                     1AD C |
 HEX2BIN :                      20F C |  HEX2OUT :                      134 C |
 HEX4BIN :                      238 C |  HEX4OUT :                      1C2 C |
 INBUF :                       4045 C |  INEND :                       4059 C |
*INEXTMODE :                      0 - |  INIT :                         151 C |
*INLWORDMODE :                    0 - |  INMAX :                         14 - |
*INMAXMODE :                      0 - | *INSRCMODE :                      0 - |
*INSUPMODE :                      0 - | *LF :                             A - |
*LISTON :                         1 - | *MACEXP :                         7 - |
*MAIN :                         174 C |  MEM_DUMP :                     246 C |
*MOMCPU :                        80 - | *MOMCPUNAME :                   Z80 - |
*NESTMAX :                      100 - |  NOTFUL :                        53 C |
 NOTWRP :                        60 C |  NRWRAP :                        8F C |
 NULL :                           0 - |  OPENMSG :                      306 C |
*PACKING :                        0 - | *PADDING :                        1 - |
 PARAM_ERRMSG :                 388 C |  PARSER :                       1CD C |
*RELAXED :                        0 - | *RST00 :                          0 C |
*RST08 :                          8 C | *RST10 :                         10 C |
*RST18 :                         18 C | *RST38 :                         38 C |
 RTS0 :                          75 C |  RTS1 :                          A3 C |
 RTSHIG :                        17 - |  RTSLOW :                        37 - |
 SERBUF :                      4000 C |  SERCNT :                      4043 C |
 SERINP :                      403F C |  SERINT :                        3B C |
 SERRDP :                      4041 C |  SPC :                           20 - |
 SPC_PRINT :                    130 C |  STACK :                       4081 - |
 STRIN :                         C3 C |  STRPR :                        11A C |
 TAB :                            9 - |
*TIME :                          23\-26\-10\-1221\-27\-12\-1236\-25\-89\-11 - |
*TRUE :                           1 - |  UARTRC :                         1 - |
 UARTRD :                         0 - |  VERMSG :                       2EB C |
 VERNAME :                                        KUNI-NET Z80 MONITOR v0.1 - |
*VERSION :                     142F - |  VERSION_OUT :                  1B2 C |
 _ABORT_DUMP :                  29C C |  _ASC16_DOT :                   2B8 C |
 _ASC16_LOOP :                  2AD C |  _ASC16_PRINT :                 2BA C |
 _ATOBIN :                      225 C |  _ATOBIN1 :                     235 C |
 _BS_RTN :                       FE C |  _CHAR_SET :                     F2 C |
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 14 - 2019/04/21 23時21分36秒


 _CMD_LOOP :                    185 C |  _DUMP16_LOOP :                 2CE C |
 _DUMP_END_CHECK :              28F C |  _DUMP_GO :                     278 C |
 _DUMP_LOOP :                   270 C |  _ERROR_EXIT :                  1A0 C |
 _HEX_CNV_PR :                  149 C |  _MAIN_LOOP :                   17A C |
*_MAIN_LOOP_END :               1A8 C |  _NEXT_CMD :                    198 C |
 _PARAM_ERR :                   296 C |  _PARAM_LOOP :                  1FF C |
 _PARSE_ERR :                   20D C |  _PARSE_LOOP :                  1E3 C |
 _PRINT_END :                   1B5 C |  _STRIN_END :                   116 C |
 _STRIN_LOOP :                   D6 C |  _WARN_BEEP :                    F9 C |

    129 symbols
     40 unused symbols

 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 15 - 2019/04/21 23時21分36秒


  codepages:
  ----------

STANDARD (0 changed characters)


0.01 seconds assembly time

    639 lines source file
      2 passes
      0 errors
      0 warnings
