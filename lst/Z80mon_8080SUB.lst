 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 1 - 2019/04/27 20時45分54秒


       1/       0 :                     ;-----------------------------------------------------------------------
       2/       0 :                     ; Z80 Monitor KUNI-NET
       3/       0 :                     ;-----------------------------------------------------------------------
       4/       0 :                     
       5/       0 :                     
       6/       0 : =DH                 CR		EQU	0DH
       7/       0 : =AH                 LF		EQU	0AH
       8/       0 : =1BH                ESC		EQU	1BH
       9/       0 : =3H                 CTRLC	EQU	03H
      10/       0 : =CH                 CLS		EQU	0CH
      11/       0 : =20H                SPC		EQU	20h
      12/       0 : =0H                 NULL	EQU 00h
      13/       0 : =7H                 BEEP	EQU 07h
      14/       0 : =8H                 BS		EQU 08h
      15/       0 : =9H                 TAB		EQU 09h
      16/       0 : =7FH                DEL		EQU 7Fh
      17/       0 :                     
      18/       0 :                     
      19/       0 :                     		ORG	0000h
      20/       0 :                     ;------------------------------------------------------------------------------
      21/       0 :                     ; RST00 リセット
      22/       0 :                     ;------------------------------------------------------------------------------
      23/       0 : F3                  RST00		DI		
      24/       1 : C3 5A 06            		JP	INIT	
      25/       4 :                     
      26/       4 :                     ;------------------------------------------------------------------------------
      27/       4 :                     ; RST08 1文字送信
      28/       4 :                     ;------------------------------------------------------------------------------
      29/       8 :                     	ORG	0008H
      30/       8 : C3 48 06            RST08		JP	COUT
      31/       B :                     
      32/       B :                     ;------------------------------------------------------------------------------
      33/       B :                     ; RST10 1文字受信
      34/       B :                     ;------------------------------------------------------------------------------
      35/      10 :                     	ORG	0010H
      36/      10 : C3 1A 06            RST10		JP	CIN
      37/      13 :                     
      38/      13 :                     ;------------------------------------------------------------------------------
      39/      13 :                     ; RST18 入力バッファチェック
      40/      13 :                     ;------------------------------------------------------------------------------
      41/      18 :                     	ORG	0018H
      42/      18 : C3 54 06            RST18		JP	CKINCHAR
      43/      1B :                     
      44/      1B :                     ;------------------------------------------------------------------------------
      45/      1B :                     ; RST38 シリアル割り込みルーチン
      46/      1B :                     ;------------------------------------------------------------------------------
      47/      38 :                     	ORG	0038H
      48/      38 : C3 DC 05            RST38:	JP	SERINT 
      49/      3B :                     ;
      50/      3B :                     ;
      51/     100 :                     	ORG 0100h
      52/     100 :                     
      53/     100 :                     ;==============================================================================
      54/     100 :                     
      55/     100 :                     ;--------------------------------------------------------------------------------
      56/     100 :                     ; メイン
      57/     100 :                     ;--------------------------------------------------------------------------------
      58/     100 :                     MAIN:
      59/     100 : 21 B1 04                LD HL,OPENMSG
      60/     103 : CD A5 01                CALL STRPR
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 2 - 2019/04/27 20時45分54秒


      61/     106 :                     _MAIN_LOOP:
      62/     106 : 21 06 01            	LD HL,_MAIN_LOOP
      63/     109 : E5                  	PUSH HL
      64/     10A :                     ;
      65/     10A : 3E 3E                   LD A,'>'
      66/     10C : CF                      RST 08h
      67/     10D : DD 21 7A 04             LD IX,CMD_TBL
      68/     111 : CD 3E 01            	CALL GETC
      69/     114 : CF                      RST 08H
      70/     115 :                     ;
      71/     115 :                     _CMD_LOOP:
      72/     115 : F5                  	PUSH AF
      73/     116 : DD 7E 00                LD A,(IX+0)
      74/     119 : B7                  	OR A
      75/     11A : 28 14               	JR Z,_ERROR_EXIT
      76/     11C : 47                  	LD B,A
      77/     11D : F1                  	POP AF
      78/     11E : B8                      CP B
      79/     11F : 20 07               	JR NZ,_NEXT_CMD
      80/     121 : DD 6E 01                LD L,(IX+1)
      81/     124 : DD 66 02            	LD H,(IX+2)
      82/     127 : E9                  	JP (HL)
      83/     128 :                     ;
      84/     128 :                     _NEXT_CMD:
      85/     128 : DD 23               	INC IX
      86/     12A : DD 23               	INC IX
      87/     12C : DD 23               	INC IX
      88/     12E : 18 E5               	JR _CMD_LOOP
      89/     130 :                     ;;
      90/     130 :                     _ERROR_EXIT
      91/     130 : F1                  	POP AF
      92/     131 : CD B4 01            	CALL CRLF_PRINT
      93/     134 : 21 D8 05            	LD HL,HATENA_MSG
      94/     137 : CD A5 01            	CALL STRPR
      95/     13A : CD B4 01            	CALL CRLF_PRINT
      96/     13D : C9                  	RET
      97/     13E :                     
      98/     13E :                     
      99/     13E :                     ;------------------------------------------------------------------------------
     100/     13E :                     ; 1文字入力 英字大文字対応
     101/     13E :                     ;------------------------------------------------------------------------------
     102/     13E :                     GETC:
     103/     13E : D7                      RST 10h
     104/     13F : FE 61                   CP 'a'
     105/     141 : F8                      RET M
     106/     142 : FE 7B                   CP 'z'+1
     107/     144 : F0                      RET P
     108/     145 : D6 20                   SUB A,20H
     109/     147 : C9                      RET
     110/     148 :                     
     111/     148 :                     ;------------------------------------------------------------------------------
     112/     148 :                     ; 文字列入力 エコーバックつき
     113/     148 :                     ;------------------------------------------------------------------------------
     114/     148 :                     STRIN:
     115/     148 :                     ; INBUF クリア
     116/     148 : 3E 00                   LD A,00H
     117/     14A : 32 44 80                LD (INBUF),A
     118/     14D : 21 44 80                LD HL,INBUF
     119/     150 : 11 45 80                LD DE,INBUF+1
     120/     153 : 01 3C 00                LD BC,INMAX
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 3 - 2019/04/27 20時45分54秒


     121/     156 : ED B0                   LDIR
     122/     158 :                     ;
     123/     158 : 21 44 80                LD HL,INBUF
     124/     15B :                     ;
     125/     15B :                     _STRIN_LOOP:
     126/     15B : CD 3E 01                CALL GETC
     127/     15E : FE 0D                   CP 0Dh
     128/     160 : 28 3F                   JR Z,_STRIN_END
     129/     162 : FE 08                   CP BS
     130/     164 : 28 23                   JR Z,_BS_RTN
     131/     166 : FE 7F               	CP DEL
     132/     168 : 28 1F                   JR Z,_BS_RTN
     133/     16A : FE 1B               	CP ESC
     134/     16C : 28 19               	JR Z,_ESC_RTN
     135/     16E :                     ;
     136/     16E :                     ; バッファENDにきた?
     137/     16E : 47                  	LD B,A
     138/     16F : 11 80 80            	LD DE,INEND
     139/     172 : 7A                  	LD A,D
     140/     173 : BC                  	CP H
     141/     174 : 20 05               	JR NZ,_CHAR_SET
     142/     176 : 7B                  	LD A,E
     143/     177 : BD                  	CP L
     144/     178 : 28 08               	JR Z,_WARN_BEEP
     145/     17A : 78                  	LD A,B
     146/     17B :                     _CHAR_SET:
     147/     17B : 77                      LD (HL),A
     148/     17C : 23                      INC HL
     149/     17D : CD AE 01                call CPRINT
     150/     180 : 18 D9                   JR _STRIN_LOOP
     151/     182 :                     ;
     152/     182 :                     _WARN_BEEP:
     153/     182 : 3E 07               	LD A,BEEP
     154/     184 : CF                  	RST 08h
     155/     185 : 18 D4                   JR _STRIN_LOOP
     156/     187 :                     ;
     157/     187 :                     _ESC_RTN:
     158/     187 : 3F                  	CCF
     159/     188 : C9                  	RET
     160/     189 :                     ;
     161/     189 :                     _BS_RTN:
     162/     189 : 11 44 80            	LD DE,INBUF
     163/     18C : 7A                  	LD A,D
     164/     18D : BC                  	CP H
     165/     18E : 20 04               	JR NZ,_BS_RTN2
     166/     190 : 7B                  	LD A,E
     167/     191 : BD                  	CP L
     168/     192 : 28 EE               	JR Z,_WARN_BEEP
     169/     194 :                     ;
     170/     194 :                     _BS_RTN2:
     171/     194 : E5                      PUSH HL
     172/     195 : 21 D4 04                LD HL,BSTXT
     173/     198 : CD A5 01                CALL STRPR
     174/     19B : E1                      POP HL
     175/     19C : 2B                      DEC HL
     176/     19D : 36 00                   LD (HL),00h
     177/     19F : 18 BA                   JR _STRIN_LOOP
     178/     1A1 :                     ;
     179/     1A1 :                     _STRIN_END:
     180/     1A1 : CD B4 01                CALL CRLF_PRINT
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 4 - 2019/04/27 20時45分54秒


     181/     1A4 : C9                      RET
     182/     1A5 :                     
     183/     1A5 :                     ;------------------------------------------------------------------------------
     184/     1A5 :                     ; 文字列出力
     185/     1A5 :                     ;------------------------------------------------------------------------------
     186/     1A5 :                     STRPR:
     187/     1A5 : 7E                      LD A,(HL)
     188/     1A6 : B7                      OR A
     189/     1A7 : C8                      RET Z
     190/     1A8 : CD AE 01                CALL CPRINT
     191/     1AB : 23                      INC HL
     192/     1AC : 18 F7                   JR STRPR
     193/     1AE :                     
     194/     1AE :                     ;------------------------------------------------------------------------------
     195/     1AE :                     ; 文字出力 (CRLF対応)
     196/     1AE :                     ; IN: A - キャラクタ
     197/     1AE :                     ; RET: なし
     198/     1AE :                     ;------------------------------------------------------------------------------
     199/     1AE :                     CPRINT:
     200/     1AE : FE 0D                   CP 0Dh
     201/     1B0 : 28 02                   JR Z,CRLF_PRINT
     202/     1B2 : CF                      RST 08h
     203/     1B3 : C9                      RET
     204/     1B4 :                     
     205/     1B4 :                     ;------------------------------------------------------------------------------
     206/     1B4 :                     ; CRLF出力 (CRLF対応)
     207/     1B4 :                     ;------------------------------------------------------------------------------
     208/     1B4 :                     CRLF_PRINT:
     209/     1B4 : 3E 0D                   LD A,0DH
     210/     1B6 : CF                      RST 08H
     211/     1B7 : 3E 0A                   LD A,0AH
     212/     1B9 : CF                      RST 08h
     213/     1BA : C9                      RET
     214/     1BB :                     
     215/     1BB :                     ;------------------------------------------------------------------------------
     216/     1BB :                     ; ブランク出力 
     217/     1BB :                     ;------------------------------------------------------------------------------
     218/     1BB :                     SPC_PRINT:
     219/     1BB : 3E 20                   LD A,SPC
     220/     1BD : CF                      RST 08H
     221/     1BE : C9                      RET
     222/     1BF :                     
     223/     1BF :                     ;------------------------------------------------------------------------------
     224/     1BF :                     ; Hex2桁出力
     225/     1BF :                     ;------------------------------------------------------------------------------
     226/     1BF :                     HEX2OUT:
     227/     1BF : C5                  	PUSH BC
     228/     1C0 : 47                  	LD B,A
     229/     1C1 : CB 3F               	SRL A
     230/     1C3 : CB 3F               	SRL A
     231/     1C5 : CB 3F               	SRL A
     232/     1C7 : CB 3F               	SRL A
     233/     1C9 : CD D4 01            	CALL _HEX_CNV_PR
     234/     1CC : 78                  	LD A,B
     235/     1CD : E6 0F               	AND 0Fh
     236/     1CF : CD D4 01            	CALL _HEX_CNV_PR
     237/     1D2 : C1                  	POP BC
     238/     1D3 : C9                  	RET
     239/     1D4 :                     ;
     240/     1D4 :                     _HEX_CNV_PR:	
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 5 - 2019/04/27 20時45分54秒


     241/     1D4 : C6 90               	ADD A,90h
     242/     1D6 : 27                  	DAA
     243/     1D7 : CE 40               	ADC	A,40h
     244/     1D9 : 27                  	DAA
     245/     1DA : CF                  	RST 08h
     246/     1DB : C9                  	RET
     247/     1DC :                     
     248/     1DC :                     ;================================================================================
     249/     1DC :                     ; ヘルプ出力
     250/     1DC :                     ;================================================================================
     251/     1DC :                     HELP_OUT:
     252/     1DC : 21 D8 04                LD HL,HELP_MSG
     253/     1DF : 18 05               	JR _PRINT_END
     254/     1E1 :                     ;
     255/     1E1 :                     ;================================================================================
     256/     1E1 :                     ; バージョン出力
     257/     1E1 :                     ;================================================================================
     258/     1E1 :                     VERSION_OUT:
     259/     1E1 : 21 96 04                LD HL,VERMSG
     260/     1E4 : 18 00               	JR _PRINT_END
     261/     1E6 :                     ;
     262/     1E6 :                     ;--------------------------------------------------------------------------------
     263/     1E6 :                     ; メッセージ出力してメインへリターン
     264/     1E6 :                     ;--------------------------------------------------------------------------------
     265/     1E6 :                     _PRINT_END:
     266/     1E6 : CD B4 01            	CALL CRLF_PRINT
     267/     1E9 : CD A5 01                CALL STRPR
     268/     1EC : CD B4 01            	CALL CRLF_PRINT
     269/     1EF : C9                      RET
     270/     1F0 :                     
     271/     1F0 :                     ;--------------------------------------------------------------------------------
     272/     1F0 :                     ; HEX4桁出力
     273/     1F0 :                     ;--------------------------------------------------------------------------------
     274/     1F0 :                     HEX4OUT:
     275/     1F0 : F5                  	PUSH AF
     276/     1F1 : 7C                  	LD A,H
     277/     1F2 : CD BF 01            	CALL HEX2OUT
     278/     1F5 : 7D                  	LD A,L
     279/     1F6 : CD BF 01            	CALL HEX2OUT
     280/     1F9 : F1                  	POP AF
     281/     1FA : C9                  	RET
     282/     1FB :                     
     283/     1FB :                     ;--------------------------------------------------------------------------------
     284/     1FB :                     ; 入力行パース
     285/     1FB :                     ;--------------------------------------------------------------------------------
     286/     1FB :                     PARSER:
     287/     1FB :                     ; 編集エリア初期化
     288/     1FB : 21 81 80            	LD HL,ARGC
     289/     1FE : 3E 00               	LD A,0
     290/     200 : 77                  	LD (HL),A
     291/     201 : 11 82 80            	LD DE,ARGC+1
     292/     204 : 01 06 00            	LD BC,ARG_AREA_LEN-1
     293/     207 : ED B0               	LDIR
     294/     209 :                     ; 入力パラメーター パース開始
     295/     209 : 4F                  	LD C,A
     296/     20A : 21 43 80            	LD HL,INBUF-1
     297/     20D : DD 21 82 80         	LD IX,ARGV_1
     298/     211 :                     ;
     299/     211 :                     _PARSE_LOOP:
     300/     211 : 23                  	INC HL
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 6 - 2019/04/27 20時45分54秒


     301/     212 : 7E                  	LD A,(HL)
     302/     213 : FE 00               	CP NULL
     303/     215 : C8                  	RET Z
     304/     216 : FE 20               	CP SPC
     305/     218 : 28 F7               	JR Z,_PARSE_LOOP
     306/     21A : 0C                      INC C
     307/     21B : 79                  	LD A,C
     308/     21C : FE 04               	CP ARG_MAX+1
     309/     21E : 30 1B               	JR NC,_PARSE_ERR
     310/     220 : 32 81 80            	LD (ARGC),A
     311/     223 : DD 75 00            	LD (IX+0),L
     312/     226 : DD 74 01            	LD (IX+1),H
     313/     229 : DD 23               	INC IX
     314/     22B : DD 23               	INC IX
     315/     22D :                     _PARAM_LOOP:
     316/     22D : 23                  	INC HL
     317/     22E : 7E                  	LD A,(HL)
     318/     22F : FE 00               	CP NULL
     319/     231 : C8                  	RET Z
     320/     232 : FE 20               	CP SPC
     321/     234 : 20 F7               	JR NZ,_PARAM_LOOP
     322/     236 : 3E 00               	LD A,NULL
     323/     238 : 77                  	LD (HL),A
     324/     239 : 18 D6               	JR _PARSE_LOOP
     325/     23B :                     ;
     326/     23B :                     _PARSE_ERR:
     327/     23B : 3F                  	CCF
     328/     23C : C9                  	RET
     329/     23D :                     
     330/     23D :                     ;--------------------------------------------------------------------------------
     331/     23D :                     ; HEX 2桁キャラクタ → Aレジスタ
     332/     23D :                     ;--------------------------------------------------------------------------------
     333/     23D :                     HEX2BIN:
     334/     23D : C5                  	PUSH BC
     335/     23E : 7E                  	LD A,(HL)
     336/     23F : CD 57 02            	CALL _ATOBIN
     337/     242 : 38 11               	JR C,_HEX2BIN_EXIT
     338/     244 : CB 27               	SLA A
     339/     246 : CB 27               	SLA A
     340/     248 : CB 27               	SLA A
     341/     24A : CB 27               	SLA A
     342/     24C : 47                  	LD B,A
     343/     24D : 23                  	INC HL
     344/     24E : 7E                  	LD A,(HL)
     345/     24F : CD 57 02            	CALL _ATOBIN
     346/     252 : 38 01               	JR C,_HEX2BIN_EXIT
     347/     254 : 80                  	ADD A,B
     348/     255 :                     _HEX2BIN_EXIT:
     349/     255 : C1                  	POP BC
     350/     256 : C9                  	RET
     351/     257 :                     ;
     352/     257 :                     _ATOBIN:
     353/     257 : FE 30               	CP '0'
     354/     259 : D8                  	RET C
     355/     25A : FE 3A               	CP '9'+1
     356/     25C : 38 09               	JR C,_ATOBIN1
     357/     25E : FE 41               	CP 'A'
     358/     260 : D8                  	RET C
     359/     261 : FE 47               	CP 'F'+1
     360/     263 : 3F                  	CCF
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 7 - 2019/04/27 20時45分54秒


     361/     264 : D8                  	RET C
     362/     265 : C6 09               	ADD A,09H
     363/     267 :                     _ATOBIN1:
     364/     267 : E6 0F               	AND 0Fh
     365/     269 : C9                  	RET
     366/     26A :                     ;
     367/     26A :                     
     368/     26A :                     ;--------------------------------------------------------------------------------
     369/     26A :                     ; 4バイト16進数文字列→バイナリ(HL)へ
     370/     26A :                     ;--------------------------------------------------------------------------------
     371/     26A :                     HEX4BIN:
     372/     26A : CD 3D 02            	CALL HEX2BIN
     373/     26D : D8                  	RET C
     374/     26E : 57                  	LD D,A
     375/     26F : 23                  	INC HL
     376/     270 : CD 3D 02            	CALL HEX2BIN
     377/     273 : D8                  	RET C
     378/     274 : 5F                  	LD E,A
     379/     275 : D5                  	PUSH DE
     380/     276 : E1                  	POP HL
     381/     277 : C9                  	RET
     382/     278 :                     ;
     383/     278 :                     ;================================================================================
     384/     278 :                     ; メモリーダンプ
     385/     278 :                     ;================================================================================
     386/     278 :                     MEM_DUMP:
     387/     278 : CD BB 01                CALL SPC_PRINT
     388/     27B :                     ;
     389/     27B : CD 48 01                CALL STRIN
     390/     27E : CD FB 01            	CALL PARSER
     391/     281 : 38 41               	JR C,_PARAM_ERR
     392/     283 :                     ; 入力パラメータ数チェック
     393/     283 : 3A 81 80            	LD A,(ARGC)
     394/     286 : FE 02               	CP 2
     395/     288 : 20 3A               	JR NZ,_PARAM_ERR
     396/     28A :                     ; 開始アドレス取得
     397/     28A : 2A 82 80            	LD HL,(ARGV_1)
     398/     28D : CD 6A 02            	CALL HEX4BIN
     399/     290 : 38 32               	JR C,_PARAM_ERR
     400/     292 : E5                  	PUSH HL
     401/     293 : DD E1               	POP IX
     402/     295 :                     ; 終了アドレス取得
     403/     295 : 2A 84 80            	LD HL,(ARGV_2)
     404/     298 : CD 6A 02            	CALL HEX4BIN
     405/     29B : 38 27               	JR C,_PARAM_ERR
     406/     29D : E5                  	PUSH HL
     407/     29E : D1                  	POP DE
     408/     29F : DD E5               	PUSH IX
     409/     2A1 : E1                  	POP HL
     410/     2A2 :                     ; ダンプ実施
     411/     2A2 :                     _DUMP_LOOP:
     412/     2A2 : DF                  	RST 18h
     413/     2A3 : 28 05               	JR Z,_DUMP_GO
     414/     2A5 : D7                  	RST 10h
     415/     2A6 : FE 1B               	CP ESC
     416/     2A8 : 28 20               	JR Z,_ABORT_DUMP
     417/     2AA :                     _DUMP_GO:
     418/     2AA : E5                  	PUSH HL
     419/     2AB : CD FB 02            	CALL DUMP16
     420/     2AE : E1                  	POP HL
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 8 - 2019/04/27 20時45分54秒


     421/     2AF : CD D0 02            	CALL ASC16
     422/     2B2 : CD B4 01            	CALL CRLF_PRINT
     423/     2B5 :                     ; 終了判定
     424/     2B5 : 7A                  	LD A,D
     425/     2B6 : BC                  	CP H
     426/     2B7 : F8                  	RET M   ; メインループへ
     427/     2B8 : 7B                  	LD A,E
     428/     2B9 : BD                  	CP L
     429/     2BA : FA BF 02            	JP M,_DUMP_END_CHECK
     430/     2BD : 18 E3               	JR _DUMP_LOOP
     431/     2BF :                     ;
     432/     2BF :                     _DUMP_END_CHECK:
     433/     2BF : 7A                  	LD A,D
     434/     2C0 : BC                  	CP H
     435/     2C1 : 20 DF               	JR NZ,_DUMP_LOOP
     436/     2C3 : C9                  	RET
     437/     2C4 :                     ;
     438/     2C4 :                     _PARAM_ERR:
     439/     2C4 : 21 97 05            	LD HL,PARAM_ERRMSG
     440/     2C7 : C3 E6 01            	JP _PRINT_END
     441/     2CA :                     ;
     442/     2CA :                     _ABORT_DUMP:
     443/     2CA : 21 AA 05            	LD HL,ABORT_MSG
     444/     2CD : C3 E6 01            	JP _PRINT_END
     445/     2D0 :                     ;--------------------------------------------------------------------------------
     446/     2D0 :                     ; 16バイト分 ASCII出力
     447/     2D0 :                     ;--------------------------------------------------------------------------------
     448/     2D0 :                     ASC16:
     449/     2D0 : CD BB 01            	CALL SPC_PRINT
     450/     2D3 : 3E 3A               	LD A,':'
     451/     2D5 : CF                  	RST 08h
     452/     2D6 : CD BB 01            	CALL SPC_PRINT
     453/     2D9 : 0E 10               	LD C,10h
     454/     2DB :                     ;
     455/     2DB :                     _ASC16_LOOP:
     456/     2DB : 7E                  	LD A,(HL)
     457/     2DC : FE 20               	CP ' '
     458/     2DE : FA E6 02            	JP M,_ASC16_DOT
     459/     2E1 : FE 7F               	CP 7Fh
     460/     2E3 : FA E8 02            	JP M,_ASC16_PRINT
     461/     2E6 :                     _ASC16_DOT:
     462/     2E6 : 3E 2E               	LD A,'.'
     463/     2E8 :                     _ASC16_PRINT:
     464/     2E8 : CF                  	RST 08h	
     465/     2E9 : 23                  	INC HL
     466/     2EA : 0D                  	DEC C
     467/     2EB : C8                  	RET Z
     468/     2EC : 18 ED               	JR _ASC16_LOOP
     469/     2EE :                     
     470/     2EE :                     ;--------------------------------------------------------------------------------
     471/     2EE :                     ; アドレス部分出力
     472/     2EE :                     ;--------------------------------------------------------------------------------
     473/     2EE :                     ADDR_OUT:
     474/     2EE : CD F0 01            	CALL HEX4OUT
     475/     2F1 : CD BB 01            	CALL SPC_PRINT
     476/     2F4 : 3E 3A               	LD A,':'
     477/     2F6 : CF                  	RST 08h
     478/     2F7 : CD BB 01            	CALL SPC_PRINT
     479/     2FA : C9                  	RET
     480/     2FB :                     
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 9 - 2019/04/27 20時45分54秒


     481/     2FB :                     ;--------------------------------------------------------------------------------
     482/     2FB :                     ; 16バイト分 HEXダンプ出力
     483/     2FB :                     ;--------------------------------------------------------------------------------
     484/     2FB :                     DUMP16:
     485/     2FB : CD EE 02            	CALL ADDR_OUT
     486/     2FE : 0E 10               	LD C,10h
     487/     300 :                     _DUMP16_LOOP:
     488/     300 : CD 0B 03            	CALL DUMP_AT
     489/     303 : CD BB 01            	CALL SPC_PRINT
     490/     306 : 23                  	INC HL
     491/     307 : 0D                  	DEC C
     492/     308 : C8                  	RET Z
     493/     309 : 18 F5               	JR _DUMP16_LOOP
     494/     30B :                     
     495/     30B :                     ;--------------------------------------------------------------------------------
     496/     30B :                     ; 1バイト分 HEXダンプ出力
     497/     30B :                     ;--------------------------------------------------------------------------------
     498/     30B :                     DUMP_AT:
     499/     30B : 7E                  	LD A,(HL)
     500/     30C : CD BF 01            	CALL HEX2OUT
     501/     30F : C9                  	RET
     502/     310 :                     
     503/     310 :                     ;--------------------------------------------------------------------------------
     504/     310 :                     ; strlen
     505/     310 :                     ;--------------------------------------------------------------------------------
     506/     310 :                     STR_LEN:
     507/     310 : E5                  	PUSH HL
     508/     311 : C5                  	PUSH BC
     509/     312 : 0E 00               	LD C,0
     510/     314 :                     _STR_LEN_LOOP:
     511/     314 : 7E                  	LD A,(HL)
     512/     315 : FE 00               	CP NULL
     513/     317 : 28 04               	JR Z,_STR_LEN_EXIT
     514/     319 : 23                  	INC HL
     515/     31A : 0C                  	INC C
     516/     31B : 18 F7               	JR _STR_LEN_LOOP
     517/     31D :                     ;
     518/     31D :                     _STR_LEN_EXIT:
     519/     31D : 79                  	LD A,C
     520/     31E : C1                  	POP BC
     521/     31F : E1                  	POP HL
     522/     320 : C9                  	RET
     523/     321 :                     ;
     524/     321 :                     ;================================================================================
     525/     321 :                     ; メモリー変更コマンド
     526/     321 :                     ;================================================================================
     527/     321 :                     MEM_CHANGE:
     528/     321 : CD BB 01                CALL SPC_PRINT
     529/     324 :                     ;
     530/     324 : CD 48 01                CALL STRIN
     531/     327 : CD FB 01            	CALL PARSER
     532/     32A :                     ;
     533/     32A :                     ; 入力パラメータ数チェック
     534/     32A : 3A 81 80            	LD A,(ARGC)
     535/     32D : FE 01               	CP 1
     536/     32F : 20 93               	JR NZ,_PARAM_ERR
     537/     331 :                     ;
     538/     331 :                     ; 開始アドレス取得
     539/     331 : 2A 82 80            	LD HL,(ARGV_1)
     540/     334 : CD 6A 02            	CALL HEX4BIN
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 10 - 2019/04/27 20時45分54秒


     541/     337 : 38 8B               	JR C,_PARAM_ERR
     542/     339 : E5                  	PUSH HL
     543/     33A : DD E1               	POP IX
     544/     33C :                     ;
     545/     33C : CD B4 01            	CALL CRLF_PRINT
     546/     33F :                     _MEM_CHANGE_LOOP:
     547/     33F : DD E5               	PUSH IX
     548/     341 : E1                  	POP HL
     549/     342 : CD EE 02            	CALL ADDR_OUT
     550/     345 : DD 7E 00            	LD A,(IX+0)
     551/     348 : CD BF 01            	CALL HEX2OUT
     552/     34B : 3E 2D               	LD A,'-'
     553/     34D : CD AE 01            	CALL CPRINT
     554/     350 : DD E5               	PUSH IX
     555/     352 :                     ;
     556/     352 : CD 48 01                CALL STRIN
     557/     355 : DA 91 03            	JP C,_MEM_CHANGE_EXIT
     558/     358 : CD FB 01            	CALL PARSER
     559/     35B :                     ; 入力パラメータ数/レングスチェック
     560/     35B : 3A 81 80            	LD A,(ARGC)
     561/     35E : FE 00               	CP 0
     562/     360 : 28 1F               	JR Z,_NEXT_ADDR
     563/     362 : FE 01               	CP 1
     564/     364 : 20 21               	JR NZ,_HATENA_OUT
     565/     366 : 2A 82 80            	LD HL,(ARGV_1)
     566/     369 : CD 10 03            	CALL STR_LEN
     567/     36C : FE 02               	CP 2
     568/     36E : 20 17               	JR NZ,_HATENA_OUT
     569/     370 : 2A 82 80            	LD HL,(ARGV_1)
     570/     373 : CD 3D 02            	CALL HEX2BIN
     571/     376 : 38 0F               	JR C,_HATENA_OUT
     572/     378 : DD E1               	POP IX
     573/     37A : DD 77 00            	LD (IX+0),A
     574/     37D : DD 23               	INC IX
     575/     37F : 18 BE               	JR _MEM_CHANGE_LOOP
     576/     381 :                     ;
     577/     381 :                     _NEXT_ADDR:
     578/     381 : DD E1               	POP IX
     579/     383 : DD 23               	INC IX
     580/     385 : 18 B8               	JR _MEM_CHANGE_LOOP
     581/     387 :                     ;
     582/     387 :                     _HATENA_OUT:
     583/     387 : 21 D8 05            	LD HL,HATENA_MSG
     584/     38A : CD A5 01            	CALL STRPR
     585/     38D : DD E1               	POP IX
     586/     38F : 18 AE               	JR _MEM_CHANGE_LOOP
     587/     391 :                     ;
     588/     391 :                     _MEM_CHANGE_EXIT:
     589/     391 : DD E1               	POP IX
     590/     393 : CD B4 01            	CALL CRLF_PRINT
     591/     396 : C9                  	RET ;ESCキーでメイン処理へ
     592/     397 :                     
     593/     397 :                     ;
     594/     397 :                     ;================================================================================
     595/     397 :                     ; プログラム実行(G)コマンド
     596/     397 :                     ;================================================================================
     597/     397 :                     PGM_GO:
     598/     397 : CD BB 01                CALL SPC_PRINT
     599/     39A :                     ;
     600/     39A : CD 48 01                CALL STRIN
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 11 - 2019/04/27 20時45分54秒


     601/     39D : CD FB 01            	CALL PARSER
     602/     3A0 :                     ;
     603/     3A0 :                     ; 入力パラメータ数チェック
     604/     3A0 : 3A 81 80            	LD A,(ARGC)
     605/     3A3 : FE 01               	CP 1
     606/     3A5 :                     ;
     607/     3A5 :                     ; 実行アドレス取得
     608/     3A5 :                     ;
     609/     3A5 : 2A 82 80            	LD HL,(ARGV_1)
     610/     3A8 : CD 10 03            	CALL STR_LEN
     611/     3AB : FE 04               	CP 4
     612/     3AD : C2 C4 02            	JP NZ,_PARAM_ERR
     613/     3B0 :                     ;
     614/     3B0 : 2A 82 80            	LD HL,(ARGV_1)
     615/     3B3 : CD 6A 02            	CALL HEX4BIN
     616/     3B6 : DA C4 02            	JP C,_PARAM_ERR
     617/     3B9 : E9                  	JP (HL)
     618/     3BA :                     ;
     619/     3BA :                     ;
     620/     3BA :                     ;================================================================================
     621/     3BA :                     ; I/O入力コマンド
     622/     3BA :                     ;================================================================================
     623/     3BA :                     IO_IN:
     624/     3BA : CD BB 01                CALL SPC_PRINT
     625/     3BD :                     ;
     626/     3BD : CD 48 01                CALL STRIN
     627/     3C0 : CD FB 01            	CALL PARSER
     628/     3C3 :                     ;
     629/     3C3 :                     ; 入力パラメータ数チェック
     630/     3C3 : 3A 81 80            	LD A,(ARGC)
     631/     3C6 : FE 01               	CP 1
     632/     3C8 : C2 C4 02            	JP NZ,_PARAM_ERR
     633/     3CB :                     ;
     634/     3CB :                     ; I/Oアドレス取得
     635/     3CB : 2A 82 80            	LD HL,(ARGV_1)
     636/     3CE : CD 10 03            	CALL STR_LEN
     637/     3D1 : FE 02               	CP 2
     638/     3D3 : C2 C4 02            	JP NZ,_PARAM_ERR
     639/     3D6 :                     ;
     640/     3D6 : 2A 82 80            	LD HL,(ARGV_1)
     641/     3D9 : CD 3D 02            	CALL HEX2BIN
     642/     3DC : DA C4 02            	JP C,_PARAM_ERR
     643/     3DF : 4F                  	LD C,A
     644/     3E0 : ED 78               	IN A,(C)
     645/     3E2 :                     ;
     646/     3E2 : CD BF 01            	CALL HEX2OUT
     647/     3E5 : CD B4 01            	CALL CRLF_PRINT
     648/     3E8 : C9                  	RET
     649/     3E9 :                     ;
     650/     3E9 :                     ;================================================================================
     651/     3E9 :                     ; I/O出力コマンド
     652/     3E9 :                     ;================================================================================
     653/     3E9 :                     IO_OUT:
     654/     3E9 : CD BB 01                CALL SPC_PRINT
     655/     3EC :                     ;
     656/     3EC : CD 48 01                CALL STRIN
     657/     3EF : CD FB 01            	CALL PARSER
     658/     3F2 :                     ;
     659/     3F2 :                     ; 入力パラメータ数チェック
     660/     3F2 : 3A 81 80            	LD A,(ARGC)
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 12 - 2019/04/27 20時45分54秒


     661/     3F5 : FE 02               	CP 2
     662/     3F7 : C2 C4 02            	JP NZ,_PARAM_ERR
     663/     3FA :                     ;
     664/     3FA :                     ; I/Oアドレス取得
     665/     3FA : 2A 82 80            	LD HL,(ARGV_1)
     666/     3FD : CD 10 03            	CALL STR_LEN
     667/     400 : FE 02               	CP 2
     668/     402 : C2 C4 02            	JP NZ,_PARAM_ERR
     669/     405 :                     ;
     670/     405 : 2A 82 80            	LD HL,(ARGV_1)
     671/     408 : CD 3D 02            	CALL HEX2BIN
     672/     40B : DA C4 02            	JP C,_PARAM_ERR
     673/     40E : 4F                  	LD C,A
     674/     40F :                     ;
     675/     40F :                     ; 出力データ取得
     676/     40F : 2A 84 80            	LD HL,(ARGV_2)
     677/     412 : CD 10 03            	CALL STR_LEN
     678/     415 : FE 02               	CP 2
     679/     417 : C2 C4 02            	JP NZ,_PARAM_ERR
     680/     41A :                     ;
     681/     41A : 2A 84 80            	LD HL,(ARGV_2)
     682/     41D : CD 3D 02            	CALL HEX2BIN
     683/     420 : DA C4 02            	JP C,_PARAM_ERR
     684/     423 :                     ;
     685/     423 : ED 79               	OUT (C),A
     686/     425 :                     ;
     687/     425 : CD B4 01            	CALL CRLF_PRINT
     688/     428 : C9                  	RET
     689/     429 :                     ;================================================================================
     690/     429 :                     ; インテルHEXロードコマンド
     691/     429 :                     ;================================================================================
     692/     429 :                     LOAD:
     693/     429 : CD B4 01            	CALL CRLF_PRINT
     694/     42C :                     ;
     695/     42C :                     _LOAD_START:
     696/     42C : D7                  	RST 10h
     697/     42D : FE 1B               	CP ESC
     698/     42F : 28 48               	JR Z,_LOAD_EXIT
     699/     431 : FE 3A               	CP ':'
     700/     433 : 20 F7               	JR NZ,_LOAD_START
     701/     435 : CF                  	RST 08h
     702/     436 :                     ;
     703/     436 :                     ; LENGTH GET
     704/     436 : 06 00               	LD B,0
     705/     438 : CD 48 01                CALL STRIN
     706/     43B :                     ;
     707/     43B : 21 44 80            	LD HL,INBUF
     708/     43E : CD 3D 02            	CALL HEX2BIN
     709/     441 : 4F                  	LD C,A
     710/     442 : 47                  	LD B,A
     711/     443 :                     ;
     712/     443 :                     ; ADDR GET
     713/     443 : 21 46 80            	LD HL,INBUF+2
     714/     446 : CD 6A 02            	CALL HEX4BIN
     715/     449 : E5                  	PUSH HL
     716/     44A : DD E1               	POP IX
     717/     44C : 78                  	LD A,B
     718/     44D : 84                  	ADD A,H
     719/     44E : 85                  	ADD A,L
     720/     44F : 47                  	LD B,A
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 13 - 2019/04/27 20時45分54秒


     721/     450 :                     ;
     722/     450 :                     ; GET RECORD TYPE
     723/     450 : 21 4A 80            	LD HL,INBUF+6
     724/     453 : CD 3D 02            	CALL HEX2BIN
     725/     456 : B7                  	OR A
     726/     457 : 20 20               	JR NZ,_LOAD_EXIT
     727/     459 :                     ;
     728/     459 :                     _MEM_LOAD_START:
     729/     459 : 21 4C 80            	LD HL,INBUF+8
     730/     45C :                     _MEM_LOAD:
     731/     45C : CD 3D 02            	CALL HEX2BIN
     732/     45F : DD 77 00            	LD (IX+0),A
     733/     462 : 80                  	ADD A,B
     734/     463 : 47                  	LD B,A
     735/     464 : 23                  	INC HL
     736/     465 : DD 23               	INC IX
     737/     467 : 0D                  	DEC C
     738/     468 : 20 F2               	JR NZ,_MEM_LOAD
     739/     46A :                     ;
     740/     46A : CD 3D 02            	CALL HEX2BIN
     741/     46D : 80                  	ADD A,B
     742/     46E : B7                  	OR A
     743/     46F : 20 02               	JR NZ,_CHECKSUM_ERROR
     744/     471 : 18 B9               	JR _LOAD_START
     745/     473 :                     ;
     746/     473 :                     _CHECKSUM_ERROR:
     747/     473 : 21 C4 05            	LD HL,CHECKSUM_ERRMSG
     748/     476 : C3 E6 01            	JP _PRINT_END
     749/     479 :                     ;
     750/     479 :                     _LOAD_EXIT:
     751/     479 : C9                  	RET
     752/     47A :                     ;
     753/     47A :                     ;--------------------------------------------------------------------------------
     754/     47A :                     ; コマンドテーブル
     755/     47A :                     ;--------------------------------------------------------------------------------
     756/     47A :                     CMD_TBL:
     757/     47A : 48                      DB 'H'
     758/     47B : DC 01                   DW HELP_OUT
     759/     47D : 3F                      DB '?'
     760/     47E : DC 01                   DW HELP_OUT
     761/     480 : 56                      DB 'V'
     762/     481 : E1 01                   DW VERSION_OUT
     763/     483 : 44                      DB 'D'
     764/     484 : 78 02                   DW MEM_DUMP
     765/     486 : 4D                      DB 'M'
     766/     487 : 21 03                   DW MEM_CHANGE
     767/     489 : 47                      DB 'G'
     768/     48A : 97 03                   DW PGM_GO
     769/     48C : 49                      DB 'I'
     770/     48D : BA 03                   DW IO_IN
     771/     48F : 4F                      DB 'O'
     772/     490 : E9 03                   DW IO_OUT
     773/     492 : 4C                      DB 'L'
     774/     493 : 29 04                   DW LOAD
     775/     495 :                     ; TABLE END
     776/     495 : 00                      DB 00h
     777/     496 :                     ;
     778/     496 :                     ;--------------------------------------------------------------------------------
     779/     496 :                     ; メッセージなど
     780/     496 :                     ;--------------------------------------------------------------------------------
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 14 - 2019/04/27 20時45分54秒


     781/     496 : =KUNI-NET Z8..      VERNAME EQU "KUNI-NET Z80 MONITOR v0.5"
     782/     496 : 4B 55 4E 49 2D 4E   VERMSG  DB VERNAME,CR,0
                    45 54 20 5A 38 30 
                    20 4D 4F 4E 49 54 
                    4F 52 20 76 30 2E 
                    35 0D 00 
     783/     4B1 : 0D 0D 2A 2A 20 4B   OPENMSG DB CR,CR,"** ",VERNAME," **",CR,0
                    55 4E 49 2D 4E 45 
                    54 20 5A 38 30 20 
                    4D 4F 4E 49 54 4F 
                    52 20 76 30 2E 35 
                    20 2A 2A 0D 00 
     784/     4D4 : 08 20 08 00         BSTXT	DB BS,SPC,BS,0
     785/     4D8 : 2D 20 2D 20 2D 20   HELP_MSG DB "- - - COMMAND HELP - - -",CR
                    43 4F 4D 4D 41 4E 
                    44 20 48 45 4C 50 
                    20 2D 20 2D 20 2D 
                    0D 
     786/     4F1 : 4D 20 58 58 58 58            DB "M XXXX ",TAB,TAB,"MEMORY EDIT",CR
                    20 09 09 4D 45 4D 
                    4F 52 59 20 45 44 
                    49 54 0D 
     787/     506 : 44 20 58 58 58 58            DB "D XXXX XXXX ",TAB,"MEMORY DUMP",CR
                    20 58 58 58 58 20 
                    09 4D 45 4D 4F 52 
                    59 20 44 55 4D 50 
                    0D 
     788/     51F : 47 20 58 58 58 58            DB "G XXXX",TAB,TAB,"PROGRAM EXECUTE",CR
                    09 09 50 52 4F 47 
                    52 41 4D 20 45 58 
                    45 43 55 54 45 0D 
     789/     537 : 49 20 58 58 09 09            DB "I XX",TAB,TAB,"I/O INPUT",CR
                    49 2F 4F 20 49 4E 
                    50 55 54 0D 
     790/     547 : 4F 20 58 58 20 58            DB "O XX XX",TAB,TAB,"I/O OUTPUT",CR
                    58 09 09 49 2F 4F 
                    20 4F 55 54 50 55 
                    54 0D 
     791/     55B : 4C 20 09 09 49 4E            DB "L ",TAB,TAB,"INTEL HEX LOAD",CR
                    54 45 4C 20 48 45 
                    58 20 4C 4F 41 44 
                    0D 
     792/     56E : 48 20 09 09 48 45            DB "H ",TAB,TAB,"HELP MESSGAE",CR
                    4C 50 20 4D 45 53 
                    53 47 41 45 0D 
     793/     57F : 56 20 09 09 56 45            DB "V ",TAB,TAB,"VERSION INFOMATION",CR,0
                    52 53 49 4F 4E 20 
                    49 4E 46 4F 4D 41 
                    54 49 4F 4E 0D 00 
     794/     597 : 07 2A 2A 20 50 41   PARAM_ERRMSG DB BEEP,"** PARAMETER ERR",CR,0
                    52 41 4D 45 54 45 
                    52 20 45 52 52 0D 
                    00 
     795/     5AA : 07 2A 2A 20 4D 45   ABORT_MSG DB BEEP,"** MEM DUMP ABORTED END",CR,0
                    4D 20 44 55 4D 50 
                    20 41 42 4F 52 54 
                    45 44 20 45 4E 44 
                    0D 00 
     796/     5C4 : 07 2A 2A 20 43 48   CHECKSUM_ERRMSG DB BEEP,"** CHECKSUM ERROR",CR,0
                    45 43 4B 53 55 4D 
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 15 - 2019/04/27 20時45分54秒


                    20 45 52 52 4F 52 
                    0D 00 
     797/     5D8 : 0D 3F 0D 00         HATENA_MSG DB CR,"?",CR,0
     798/     5DC :                     
     799/     5DC :                     ;
     800/     5DC :                     ;
     801/     5DC :                     ;------------------------------------------------------------------------------
     802/     5DC :                     ; デバイス依存ルーチン (deviceディレクトリに配置)
     803/     5DC :                     ;------------------------------------------------------------------------------
     804/     5DC : =>UNDEFINED         	IFDEF MC6850
     805/     5DC :                     	  include "device/KZ80_6850.asm"
     806/     5DC : [804]               	ENDIF
     807/     5DC :                     
     808/     5DC : =>DEFINED           	IFDEF SBC8080SUB
     809/     5DC :                     	  include "device/SBC8080SUB.asm" 
(1)    1/     5DC :                     ;
(1)    2/     5DC :                     ; SBC8080 SUBボード用 モジュール
(1)    3/     5DC :                     ;
(1)    4/     5DC :                     ;--------------------------------------------------------
(1)    5/     5DC :                     ; 以下のルーチンはSBC8080データパックのASMソースを参考にさせていただきました。
(1)    6/     5DC :                     ;  SERINT 	8251シリアル割り込みルーチン
(1)    7/     5DC :                     ;  CIN		シリアル1文字入力ルーチン
(1)    8/     5DC :                     ;  COUT		シリアル1文字出力ルーチン
(1)    9/     5DC :                     ;  CKINCHAR	シリアルバッファチェックルーチン
(1)   10/     5DC :                     
(1)   11/     5DC : =0H                 UARTRD	EQU	00H
(1)   12/     5DC : =1H                 UARTRC	EQU	01H
(1)   13/     5DC :                     ;
(1)   14/     5DC : =3FH                BUFSIZ	EQU	3FH
(1)   15/     5DC : =30H                BUFFUL	EQU	30H
(1)   16/     5DC : =5H                 BUFEMP	EQU	5
(1)   17/     5DC :                     ;
(1)   18/     5DC : =17H                RTSHIG	EQU	00010111B
(1)   19/     5DC : =37H                RTSLOW	EQU	00110111B
(1)   20/     5DC :                     
(1)   21/     5DC :                     ;------------------------------------------------------------------------------
(1)   22/     5DC :                     ; 8251割り込みルーチン
(1)   23/     5DC :                     ;------------------------------------------------------------------------------
(1)   24/     5DC : F5                  SERINT:	PUSH	AF
(1)   25/     5DD : E5                  	PUSH	HL
(1)   26/     5DE : DB 01               	IN	A,(UARTRC)
(1)   27/     5E0 : E6 02               	AND	00000010B
(1)   28/     5E2 : CA 16 06            	JP	Z,RTS0
(1)   29/     5E5 : DB 00               	IN	A,(UARTRD)
(1)   30/     5E7 : F5                  	PUSH	AF
(1)   31/     5E8 : 3A 43 80            	LD	A,(SERCNT)
(1)   32/     5EB : FE 3F               	CP	BUFSIZ
(1)   33/     5ED : C2 F4 05            	JP	NZ,NOTFUL
(1)   34/     5F0 : F1                  	POP	AF
(1)   35/     5F1 : C3 16 06            	JP	RTS0
(1)   36/     5F4 : 2A 3F 80            NOTFUL:	LD	HL,(SERINP)
(1)   37/     5F7 : 23                  	INC	HL
(1)   38/     5F8 : 7D                  	LD	A,L
(1)   39/     5F9 : FE 3F               	CP	SERINP & 0FFH
(1)   40/     5FB : C2 01 06            	JP	NZ,NOTWRP
(1)   41/     5FE : 21 00 80            	LD	HL,SERBUF
(1)   42/     601 : 22 3F 80            NOTWRP:	LD	(SERINP),HL
(1)   43/     604 : F1                  	POP	AF
(1)   44/     605 : 77                  	LD	(HL),A
(1)   45/     606 : 3A 43 80            	LD	A,(SERCNT)
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm(SBC8080SUB.asm) - page 16 - 2019/04/27 20時45分54秒


(1)   46/     609 : 3C                  	INC	A
(1)   47/     60A : 32 43 80            	LD	(SERCNT),A
(1)   48/     60D : FE 30               	CP	BUFFUL
(1)   49/     60F : DA 16 06            	JP	C,RTS0
(1)   50/     612 : 3E 17               	LD	A,RTSHIG
(1)   51/     614 : D3 01               	OUT	(UARTRC),A
(1)   52/     616 : E1                  RTS0:	POP	HL
(1)   53/     617 : F1                  	POP	AF
(1)   54/     618 : FB                  	EI
(1)   55/     619 : C9                  	RET
(1)   56/     61A :                     
(1)   57/     61A :                     ;------------------------------------------------------------------------------
(1)   58/     61A :                     ; 1文字入力(バッファから)
(1)   59/     61A :                     ;------------------------------------------------------------------------------
(1)   60/     61A :                     CIN:
(1)   61/     61A : 3A 43 80            	LD	A,(SERCNT)
(1)   62/     61D : FE 00               	CP	00H
(1)   63/     61F : CA 1A 06            	JP	Z,CIN
(1)   64/     622 : E5                  	PUSH	HL
(1)   65/     623 : 2A 41 80            	LD	HL,(SERRDP)
(1)   66/     626 : 23                  	INC	HL
(1)   67/     627 : 7D                  	LD	A,L
(1)   68/     628 : FE 3F               	CP	SERINP & 0FFH
(1)   69/     62A : C2 30 06            	JP	NZ,NRWRAP
(1)   70/     62D : 21 00 80            	LD	HL,SERBUF
(1)   71/     630 : F3                  NRWRAP:	DI
(1)   72/     631 : 22 41 80            	LD	(SERRDP),HL
(1)   73/     634 : 3A 43 80            	LD	A,(SERCNT)
(1)   74/     637 : 3D                  	DEC	A
(1)   75/     638 : 32 43 80            	LD	(SERCNT),A
(1)   76/     63B : FE 05               	CP	BUFEMP
(1)   77/     63D : D2 44 06            	JP	NC,RTS1
(1)   78/     640 : 3E 37               	LD	A,RTSLOW
(1)   79/     642 : D3 01               	OUT	(UARTRC),A
(1)   80/     644 : 7E                  RTS1:	LD	A,(HL)
(1)   81/     645 : FB                  	EI
(1)   82/     646 : E1                  	POP	HL
(1)   83/     647 : C9                  	RET	
(1)   84/     648 :                     
(1)   85/     648 :                     ;------------------------------------------------------------------------------
(1)   86/     648 :                     ; 1文字出力
(1)   87/     648 :                     ;------------------------------------------------------------------------------
(1)   88/     648 : F5                  COUT:		PUSH	AF
(1)   89/     649 : DB 01               COUT1:	IN	A,(UARTRC)
(1)   90/     64B : E6 01               	AND	01H     
(1)   91/     64D : CA 49 06            	JP	Z,COUT1
(1)   92/     650 : F1                  	POP	AF
(1)   93/     651 : D3 00               	OUT	(UARTRD),A
(1)   94/     653 : C9                  	RET
(1)   95/     654 :                     
(1)   96/     654 :                     ;------------------------------------------------------------------------------
(1)   97/     654 :                     ; 入力バッファチェック
(1)   98/     654 :                     ;------------------------------------------------------------------------------
(1)   99/     654 : 3A 43 80            CKINCHAR	LD	A,(SERCNT)
(1)  100/     657 : FE 00               	CP	00H
(1)  101/     659 : C9                  	RET
(1)  102/     65A :                     
(1)  103/     65A :                     ;------------------------------------------------------------------------------
(1)  104/     65A :                     ; 初期化
(1)  105/     65A :                     ;------------------------------------------------------------------------------
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm(SBC8080SUB.asm) - page 17 - 2019/04/27 20時45分54秒


(1)  106/     65A :                     INIT:		
(1)  107/     65A : 31 A8 80                LD  SP,STACK
(1)  108/     65D : 21 00 80            	LD	HL,SERBUF
(1)  109/     660 : 22 3F 80            	LD	(SERINP),HL
(1)  110/     663 : 22 41 80            	LD	(SERRDP),HL
(1)  111/     666 : AF                  	XOR	A
(1)  112/     667 : 32 43 80            	LD	(SERCNT),A
(1)  113/     66A : D3 01               	OUT	(UARTRC),A
(1)  114/     66C : D3 01               	OUT	(UARTRC),A
(1)  115/     66E : D3 01               	OUT	(UARTRC),A
(1)  116/     670 : 3E 40               	LD	A,01000000B
(1)  117/     672 : D3 01               	OUT	(UARTRC),A
(1)  118/     674 : 3E 4E               	LD	A,01001110B
(1)  119/     676 : D3 01               	OUT	(UARTRC),A
(1)  120/     678 : 3E 37               	LD	A,RTSLOW
(1)  121/     67A : D3 01               	OUT	(UARTRC),A
(1)  122/     67C : FB                  	EI
(1)  123/     67D :                     ;
(1)  124/     67D : C3 00 01                JP MAIN
(1)  125/     680 :                     
(1)  126/     680 :                     ;
(1)  127/     680 :                     ; RAM 8000h〜
(1)  128/     680 :                     ;
(1)  129/    8000 :                         ORG 8000h
(1)  130/    8000 :                     ;
(1)  131/    8000 :                     SERBUF	DS	BUFSIZ
(1)  132/    803F :                     SERINP	DS	2
(1)  133/    8041 :                     SERRDP	DS	2
(1)  134/    8043 :                     SERCNT	DS	1
(1)  135/    8044 :                     ;
(1)  136/    8044 : =8044H              DEVICE_RAM_END EQU $
(1)  137/    8044 :                     
     810/    8044 : [808]               	ENDIF
     811/    8044 :                     
     812/    8044 : =>UNDEFINED         	IFDEF KZ80
     813/    8044 :                     	  include "device/KZ80_8251.asm"
     814/    8044 : [812]               	ENDIF
     815/    8044 :                     ;
     816/    8044 :                     ;------------------------------------------------------------------------------
     817/    8044 :                     ; RAM バッファ & STACK
     818/    8044 :                     ;------------------------------------------------------------------------------
     819/    8044 :                     	ORG DEVICE_RAM_END
     820/    8044 :                     ;
     821/    8044 :                     INBUF   DS  60
     822/    8080 : =3CH                INMAX   EQU  $-INBUF
     823/    8080 :                     INEND   DS  1
     824/    8081 :                     ;
     825/    8081 :                     ARGC	DS	1
     826/    8082 :                     ARGV_1	DS	2
     827/    8084 :                     ARGV_2	DS	2
     828/    8086 :                     ARGV_3	DS	2
     829/    8088 : =3H                 ARG_MAX	EQU ($-ARGV_1)/2
     830/    8088 : =7H                 ARG_AREA_LEN EQU $-ARGC
     831/    8088 :                     ;
     832/    8088 :                         	DS	32
     833/    80A8 : =80A8H              STACK   EQU $
     834/    80A8 :                     
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 18 - 2019/04/27 20時45分54秒


  symbol table (* = unused):
  ------------------------

 ABORT_MSG :                    5AA C |  ADDR_OUT :                     2EE C |
*ARCHITECTURE :    x86_64-apple-osx - |  ARGC :                        8081 C |
 ARGV_1 :                      8082 C |  ARGV_2 :                      8084 C |
*ARGV_3 :                      8086 C |  ARG_AREA_LEN :                   7 - |
 ARG_MAX :                        3 - |  ASC16 :                        2D0 C |
 BEEP :                           7 - | *BIGENDIAN :                      0 - |
*BRANCHEXT :                      0 - |  BS :                             8 - |
 BSTXT :                        4D4 C |  BUFEMP :                         5 - |
 BUFFUL :                        30 - |  BUFSIZ :                        3F - |
*CASESENSITIVE :                  0 - |  CHECKSUM_ERRMSG :              5C4 C |
 CIN :                          61A C |  CKINCHAR :                     654 C |
*CLS :                            C - |  CMD_TBL :                      47A C |
*CONSTPI :        3.141592653589793 - |  COUT :                         648 C |
 COUT1 :                        649 C |  CPRINT :                       1AE C |
 CR :                             D - |  CRLF_PRINT :                   1B4 C |
*CTRLC :                          3 - | *DATE :                  2019/04/27 - |
 DEL :                           7F - |  DEVICE_RAM_END :              8044 - |
 DUMP16 :                       2FB C |  DUMP_AT :                      30B C |
 ESC :                           1B - | *FALSE :                          0 - |
*FULLPMMU :                       1 - |  GETC :                         13E C |
*HAS64 :                          1 - | *HASDSP :                         0 - |
*HASFPU :                         0 - | *HASPMMU :                        0 - |
 HATENA_MSG :                   5D8 C |  HELP_MSG :                     4D8 C |
 HELP_OUT :                     1DC C |  HEX2BIN :                      23D C |
 HEX2OUT :                      1BF C |  HEX4BIN :                      26A C |
 HEX4OUT :                      1F0 C |  INBUF :                       8044 C |
 INEND :                       8080 C | *INEXTMODE :                      0 - |
 INIT :                         65A C | *INLWORDMODE :                    0 - |
 INMAX :                         3C - | *INMAXMODE :                      0 - |
*INSRCMODE :                      0 - | *INSUPMODE :                      0 - |
 IO_IN :                        3BA C |  IO_OUT :                       3E9 C |
*LF :                             A - | *LISTON :                         1 - |
 LOAD :                         429 C | *MACEXP :                         7 - |
 MAIN :                         100 C |  MEM_CHANGE :                   321 C |
 MEM_DUMP :                     278 C | *MOMCPU :                        80 - |
*MOMCPUNAME :                   Z80 - | *NESTMAX :                      100 - |
 NOTFUL :                       5F4 C |  NOTWRP :                       601 C |
 NRWRAP :                       630 C |  NULL :                           0 - |
 OPENMSG :                      4B1 C | *PACKING :                        0 - |
*PADDING :                        1 - |  PARAM_ERRMSG :                 597 C |
 PARSER :                       1FB C |  PGM_GO :                       397 C |
*RELAXED :                        0 - | *RST00 :                          0 C |
*RST08 :                          8 C | *RST10 :                         10 C |
*RST18 :                         18 C | *RST38 :                         38 C |
 RTS0 :                         616 C |  RTS1 :                         644 C |
 RTSHIG :                        17 - |  RTSLOW :                        37 - |
*SBC8080SUB :                     1 - |  SERBUF :                      8000 C |
 SERCNT :                      8043 C |  SERINP :                      803F C |
 SERINT :                       5DC C |  SERRDP :                      8041 C |
 SPC :                           20 - |  SPC_PRINT :                    1BB C |
 STACK :                       80A8 - |  STRIN :                        148 C |
 STRPR :                        1A5 C |  STR_LEN :                      310 C |
 TAB :                            9 - |
*TIME :                          20\-26\-10\-1245\-27\-12\-1254\-25\-89\-11 - |
*TRUE :                           1 - |  UARTRC :                         1 - |
 UARTRD :                         0 - |  VERMSG :                       496 C |
 VERNAME :                                        KUNI-NET Z80 MONITOR v0.5 - |
 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 19 - 2019/04/27 20時45分54秒


*VERSION :                     142F - |  VERSION_OUT :                  1E1 C |
 _ABORT_DUMP :                  2CA C |  _ASC16_DOT :                   2E6 C |
 _ASC16_LOOP :                  2DB C |  _ASC16_PRINT :                 2E8 C |
 _ATOBIN :                      257 C |  _ATOBIN1 :                     267 C |
 _BS_RTN :                      189 C |  _BS_RTN2 :                     194 C |
 _CHAR_SET :                    17B C |  _CHECKSUM_ERROR :              473 C |
 _CMD_LOOP :                    115 C |  _DUMP16_LOOP :                 300 C |
 _DUMP_END_CHECK :              2BF C |  _DUMP_GO :                     2AA C |
 _DUMP_LOOP :                   2A2 C |  _ERROR_EXIT :                  130 C |
 _ESC_RTN :                     187 C |  _HATENA_OUT :                  387 C |
 _HEX2BIN_EXIT :                255 C |  _HEX_CNV_PR :                  1D4 C |
 _LOAD_EXIT :                   479 C |  _LOAD_START :                  42C C |
 _MAIN_LOOP :                   106 C |  _MEM_CHANGE_EXIT :             391 C |
 _MEM_CHANGE_LOOP :             33F C |  _MEM_LOAD :                    45C C |
*_MEM_LOAD_START :              459 C |  _NEXT_ADDR :                   381 C |
 _NEXT_CMD :                    128 C |  _PARAM_ERR :                   2C4 C |
 _PARAM_LOOP :                  22D C |  _PARSE_ERR :                   23B C |
 _PARSE_LOOP :                  211 C |  _PRINT_END :                   1E6 C |
 _STRIN_END :                   1A1 C |  _STRIN_LOOP :                  15B C |
 _STR_LEN_EXIT :                31D C |  _STR_LEN_LOOP :                314 C |
 _WARN_BEEP :                   182 C |

    152 symbols
     39 unused symbols

 AS V1.42 Beta [Bld 137] - source file Z80mon.asm - page 20 - 2019/04/27 20時45分54秒


  codepages:
  ----------

STANDARD (0 changed characters)


0.01 seconds assembly time

    971 lines source file
      2 passes
      0 errors
      0 warnings
